"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const axios_1 = __importDefault(require("axios"));
const qs_1 = require("qs");
const RPCError_1 = require("./Errors/RPCError");
const Response_1 = require("./Abstracts/Response");
const ErrorResponse_1 = require("./Abstracts/ErrorResponse");
exports.ErrorResponse = ErrorResponse_1.ErrorResponse;
class Client {
    constructor(config) {
        config = {
            headers: {
                'Content-Type': 'application/json'
            },
            ...config,
            ...{ paramsSerializer: qs_1.stringify }
        };
        if (config.baseURL) {
            let parsedUrl = new URL(config.baseURL);
            if (parsedUrl.username) {
                let credentials = {
                    username: parsedUrl.username,
                    password: parsedUrl.password,
                };
                delete parsedUrl.username;
                delete parsedUrl.password;
                config['auth'] = credentials;
                config['baseURL'] = parsedUrl.href;
            }
        }
        this.axios = axios_1.default.create(config);
    }
    mapResponse(response, multiple) {
        if (response instanceof Array) {
            return response.map((item) => {
                return this.mapResponse(item, true);
            });
        }
        else {
            if (response.error) {
                if (multiple) {
                    throw new ErrorResponse_1.ErrorResponse(response.error);
                }
                else {
                    throw new RPCError_1.RPCError(response.error, response.error.message || 'RPC Error', response.error.code || -32003);
                }
            }
            else {
                if (multiple) {
                    let result = new Response_1.Response();
                    result.code = response.code;
                    result.id = response.id;
                    result.jsonrpc = response.jsonrpc;
                    result.result = response.result;
                    return result;
                }
                else {
                    return response.result;
                }
            }
        }
    }
    async request(url, params) {
        return this.axios
            .post(url, params || this.defaultParams, {})
            .then(response => (response ? response.data : response))
            .catch((err) => {
            if (err.response && err.response.data) {
                return this.mapResponse(err.response.data);
            }
            throw err;
        });
    }
    rpc(...args) {
        let data = args.flat(Infinity)
            .map((item, i) => {
            return {
                id: ++i,
                jsonrpc: '2.0',
                ...item,
            };
        });
        if (data.length === 1) {
            data = data[0];
        }
        return this
            .request('', data)
            .then(data => {
            return this.mapResponse(data);
        })
            .then((data) => data);
    }
}
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvQ2xpZW50L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsa0RBQTBGO0FBQzFGLDJCQUFpRDtBQUNqRCxnREFBMkM7QUFDM0MsbURBQThDO0FBQzlDLDZEQUF3RDtBQVVoRCx3QkFWQSw2QkFBYSxDQVVBO0FBS3JCLE1BQWEsTUFBTTtJQUlmLFlBQVksTUFBcUI7UUFDN0IsTUFBTSxHQUFHO1lBQ0wsT0FBTyxFQUFFO2dCQUNMLGNBQWMsRUFBRSxrQkFBa0I7YUFDckM7WUFDRCxHQUFHLE1BQU07WUFDVCxHQUFHLEVBQUMsZ0JBQWdCLEVBQWhCLGNBQWdCLEVBQUM7U0FDeEIsQ0FBQztRQUVGLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtZQUNoQixJQUFJLFNBQVMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDeEMsSUFBSSxTQUFTLENBQUMsUUFBUSxFQUFFO2dCQUNwQixJQUFJLFdBQVcsR0FBRztvQkFDZCxRQUFRLEVBQUUsU0FBUyxDQUFDLFFBQVE7b0JBQzVCLFFBQVEsRUFBRSxTQUFTLENBQUMsUUFBUTtpQkFDL0IsQ0FBQztnQkFDRixPQUFPLFNBQVMsQ0FBQyxRQUFRLENBQUM7Z0JBQzFCLE9BQU8sU0FBUyxDQUFDLFFBQVEsQ0FBQztnQkFDMUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLFdBQVcsQ0FBQztnQkFDN0IsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7YUFDdEM7U0FDSjtRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsZUFBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBS0QsV0FBVyxDQUFDLFFBQXVDLEVBQUUsUUFBa0I7UUFDbkUsSUFBSSxRQUFRLFlBQVksS0FBSyxFQUFFO1lBQzNCLE9BQU8sUUFBUSxDQUFD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UmVxdWVzdENvbmZpZywgQXhpb3NSZXNwb25zZX0gZnJvbSBcImF4aW9zXCI7XG5pbXBvcnQge3N0cmluZ2lmeSBhcyBwYXJhbXNTZXJpYWxpemVyfSBmcm9tICdxcyc7XG5pbXBvcnQge1JQQ0Vycm9yfSBmcm9tIFwiLi9FcnJvcnMvUlBDRXJyb3JcIjtcbmltcG9ydCB7UmVzcG9uc2V9IGZyb20gXCIuL0Fic3RyYWN0cy9SZXNwb25zZVwiO1xuaW1wb3J0IHtFcnJvclJlc3BvbnNlfSBmcm9tIFwiLi9BYnN0cmFjdHMvRXJyb3JSZXNwb25zZVwiO1xuaW1wb3J0IHtSUEN9IGZyb20gXCIuLi9AdHlwZXMvdHlwZXNcIjtcblxuZXhwb3J0IHR5cGUgQ2xpZW50T3B0aW9ucyA9IEF4aW9zUmVxdWVzdENvbmZpZztcblxudHlwZSBycGNSZXR1cm5UeXBlID0gUmVzcG9uc2UgfCBFcnJvciA7XG5cbnR5cGUgVE1hcFJlc291cmNlID0gUlBDLlJlc3BvbnNlLklEYXRhO1xudHlwZSBUTWFwUmV0dXJuVHlwZSA9IFJlc3BvbnNlIHwgRXJyb3I7XG5cbmV4cG9ydCB7RXJyb3JSZXNwb25zZX07XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2xpZW50IHtcbn1cblxuZXhwb3J0IGNsYXNzIENsaWVudCB7XG4gICAgYXhpb3M6IEF4aW9zSW5zdGFuY2U7XG4gICAgZGVmYXVsdFBhcmFtczogW107XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IENsaWVudE9wdGlvbnMpIHtcbiAgICAgICAgY29uZmlnID0ge1xuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAuLi5jb25maWcsXG4gICAgICAgICAgICAuLi57cGFyYW1zU2VyaWFsaXplcn1cbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoY29uZmlnLmJhc2VVUkwpIHtcbiAgICAgICAgICAgIGxldCBwYXJzZWRVcmwgPSBuZXcgVVJMKGNvbmZpZy5iYXNlVVJMKTtcbiAgICAgICAgICAgIGlmIChwYXJzZWRVcmwudXNlcm5hbWUpIHtcbiAgICAgICAgICAgICAgICBsZXQgY3JlZGVudGlhbHMgPSB7XG4gICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiBwYXJzZWRVcmwudXNlcm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBwYXJzZWRVcmwucGFzc3dvcmQsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBkZWxldGUgcGFyc2VkVXJsLnVzZXJuYW1lO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBwYXJzZWRVcmwucGFzc3dvcmQ7XG4gICAgICAgICAgICAgICAgY29uZmlnWydhdXRoJ10gPSBjcmVkZW50aWFscztcbiAgICAgICAgICAgICAgICBjb25maWdbJ2Jhc2VVUkwnXSA9IHBhcnNlZFVybC5ocmVmO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuYXhpb3MgPSBBeGlvcy5jcmVhdGUoY29uZmlnKTtcbiAgICB9XG5cblxuICAgIG1hcFJlc3BvbnNlKHJlc3BvbnNlOiBUTWFwUmVzb3VyY2VbXSwgbXVsdGlwbGU/OiBib29sZWFuKTogVE1hcFJldHVyblR5cGVbXTtcbiAgICBtYXBSZXNwb25zZShyZXNwb25zZTogVE1hcFJlc291cmNlLCBtdWx0aXBsZT86IGJvb2xlYW4pOiBUTWFwUmV0dXJuVHlwZTtcbiAgICBtYXBSZXNwb25zZShyZXNwb25zZTogVE1hcFJlc291cmNlIHwgVE1hcFJlc291cmNlW10sIG11bHRpcGxlPzogYm9vbGVhbik6IFRNYXBSZXR1cm5UeXBlIHwgVE1hcFJldHVyblR5cGVbXSB7XG4gICAgICAgIGlmIChyZXNwb25zZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UubWFwKChpdGVtOiBUTWFwUmVzb3VyY2UpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tYXBSZXNwb25zZShpdGVtLCB0cnVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7XG4gICAgICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvclJlc3BvbnNlKHJlc3BvbnNlLmVycm9yKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUlBDRXJyb3IocmVzcG9uc2UuZXJyb3IsIHJlc3BvbnNlLmVycm9yLm1lc3NhZ2UgfHwgJ1JQQyBFcnJvcicsIHJlc3BvbnNlLmVycm9yLmNvZGUgfHwgLTMyMDAzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gbmV3IFJlc3BvbnNlKCk7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5jb2RlID0gcmVzcG9uc2UuY29kZTtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmlkID0gcmVzcG9uc2UuaWQ7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5qc29ucnBjID0gcmVzcG9uc2UuanNvbnJwYztcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJlc3VsdCA9IHJlc3BvbnNlLnJlc3VsdDtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVzdWx0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgYXN5bmMgcmVxdWVzdCh1cmwsIHBhcmFtcyk6IFByb21pc2U8QXhpb3NSZXNwb25zZSB8IEF4aW9zUmVzcG9uc2VbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5heGlvc1xuICAgICAgICAgICAgLnBvc3QodXJsLCBwYXJhbXMgfHwgdGhpcy5kZWZhdWx0UGFyYW1zLCB7fSlcbiAgICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IChyZXNwb25zZSA/IHJlc3BvbnNlLmRhdGEgOiByZXNwb25zZSkpXG4gICAgICAgICAgICAuY2F0Y2goKGVycjogQXhpb3NFcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIucmVzcG9uc2UgJiYgZXJyLnJlc3BvbnNlLmRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwUmVzcG9uc2UoZXJyLnJlc3BvbnNlLmRhdGEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBycGM8VD4oYXJnczogUlBDLklQYXlsb2FkKTogUHJvbWlzZTxUPjtcbiAgICBycGM8VD4oYXJnMTogUlBDLklQYXlsb2FkLCAuLi5hcmdzOiBSUEMuSVBheWxvYWRbXSk6IFByb21pc2U8VFtdPjtcbiAgICBycGM8VD4oYXJnczogUlBDLklQYXlsb2FkW10pOiBQcm9taXNlPFQ+O1xuICAgIHJwYzxUPiguLi5hcmdzOiAoUlBDLklQYXlsb2FkIHwgUlBDLklQYXlsb2FkW10pW10pOiBQcm9taXNlPFQ+IHtcbiAgICAgICAgbGV0IGRhdGE6IChSUEMuSVBheWxvYWQgfCBSUEMuSVBheWxvYWRbXSkgPSBhcmdzLmZsYXQoSW5maW5pdHkpXG4gICAgICAgICAgICAubWFwKChpdGVtLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6ICsraSxcbiAgICAgICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgICAgIC4uLml0ZW0sXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgZGF0YSA9IGRhdGFbMF07XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpc1xuICAgICAgICAgICAgLnJlcXVlc3QoJycsIGRhdGEpXG4gICAgICAgICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tYXBSZXNwb25zZShkYXRhIGFzIGFueSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKGRhdGE6IGFueSkgPT4gZGF0YSk7XG4gICAgfVxufVxuIl19