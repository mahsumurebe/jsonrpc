"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const Routes_1 = require("./Library/Routes");
const ParseError_1 = require("./Errors/ParseError");
const events_1 = require("events");
const InvalidParams_1 = require("./Errors/InvalidParams");
const Output_1 = require("./Library/Output");
exports.Output = Output_1.Output;
const bodyParser = require("body-parser");
class Server extends events_1.EventEmitter {
    constructor() {
        super();
        this.handle = express_1.default();
        this.routes = new Routes_1.Routes();
    }
    init() {
        let app = this.handle;
        app.set('trust proxy', true);
        //region Middlewares
        //For request emitter
        app.use(bodyParser.urlencoded({ extended: false }));
        app.use(bodyParser.json());
        // Error catch for bodyParser
        app.use((err, req, res, next) => {
            if (err instanceof SyntaxError) {
                next(new ParseError_1.ParseError());
            }
            else {
                next(err, req, res);
            }
        });
        //Parsing body
        app.use((req, res, next) => {
            if (!req.body) {
                return next(new InvalidParams_1.InvalidParams({
                    message: 'Request body not found.'
                }));
            }
            if ('object' !== typeof req.body || !('string' === typeof req.body.method && req.body.id && req.body.id)) {
                return next(new InvalidParams_1.InvalidParams({
                    message: 'Invalid JSON-RPC Request Body'
                }));
            }
            next();
        });
        //endregion
        app.use((req, res, next) => {
            this.emit('request', req.body, req, res);
            next();
        });
        app.use((err, req, res, next) => {
            let output = Output_1.Output.generate(err, req.body || {}, res);
            res
                .send(output)
                .end();
            this.emit('error', err, req, res);
        });
        app.post('/?$', (req, res) => {
            this.emit('routing', req, res);
            Promise
                .resolve(null)
                .then(() => {
                let body = req.body;
                return this.routes.call(body.method, body.params, req, res);
            })
                .then((result) => {
                //On success
                let output = Output_1.Output.generate(result, req.body || {}, res);
                this.emit('response', output);
                res
                    .send(output)
                    .end();
            }, (e) => {
                //On error
                let output = Output_1.Output.generate(e, req.body || {}, res);
                res
                    .send(output)
                    .end();
                this.emit('error', e, req, res);
            });
        });
        app.get('/?$', (req, res) => {
            throw new ParseError_1.ParseError();
        });
    }
    listen(port, host) {
        return new Promise((succ, err) => {
            return this.listener = this.handle.listen(port, host, () => {
                let address = this.listener.address();
                this.emit('ready', address);
                //TODO: Teyfik'e sor
                succ(this.listener);
            }).on('error', err);
        });
    }
}
exports.Server = Server;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvU2VydmVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsc0RBQWtEO0FBQ2xELDZDQUF3QztBQUN4QyxvREFBK0M7QUFDL0MsbUNBQW9DO0FBRXBDLDBEQUFxRDtBQUVyRCw2Q0FBd0M7QUFJaEMsaUJBSkEsZUFBTSxDQUlBO0FBRmQsMENBQTJDO0FBMEUzQyxNQUFhLE1BQU8sU0FBUSxxQkFBWTtJQUtwQztRQUNJLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxpQkFBTyxFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLGVBQU0sRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFRCxJQUFJO1FBQ0EsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUN0QixHQUFHLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUU3QixvQkFBb0I7UUFFcEIscUJBQXFCO1FBQ3JCLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxFQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUUzQiw2QkFBNkI7UUFDN0IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQzVCLElBQUksR0FBRyxZQUFZLFdBQVcsRUFBRTtnQkFDNUIsSUFBSSxDQUFDLElBQUksdUJBQVUsRUFBRSxDQUFDLENBQUM7YUFDMUI7aUJBQU07Z0JBQ0gsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7YUFDdkI7UUFDTCxDQUFDLENBQUMsQ0FBQztR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Q1osR0FBRyxFQUFFLENBQUM7Z0JBQ1gsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNwQyxDQUFDLENBQUMsQ0FBQztRQUNYLENBQUMsQ0FBQyxDQUFDO1FBQ0gsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDeEIsTUFBTSxJQUFJLHVCQUFVLEVBQUUsQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFHRCxNQUFNLENBQUMsSUFBWSxFQUFFLElBQWE7UUFDOUIsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUM3QixPQUFPLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUU7Z0JBQ3ZELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ3RDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUM1QixvQkFBb0I7Z0JBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDeEIsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN4QixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQWxHRCx3QkFrR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcywge0V4cHJlc3MsIFJlcXVlc3R9IGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQge1JvdXRlc30gZnJvbSBcIi4vTGlicmFyeS9Sb3V0ZXNcIjtcbmltcG9ydCB7UGFyc2VFcnJvcn0gZnJvbSBcIi4vRXJyb3JzL1BhcnNlRXJyb3JcIjtcbmltcG9ydCB7RXZlbnRFbWl0dGVyfSBmcm9tIFwiZXZlbnRzXCI7XG5pbXBvcnQgKiBhcyBodHRwIGZyb20gXCJodHRwXCI7XG5pbXBvcnQge0ludmFsaWRQYXJhbXN9IGZyb20gXCIuL0Vycm9ycy9JbnZhbGlkUGFyYW1zXCI7XG5pbXBvcnQge1JQQ30gZnJvbSBcIi4uL0B0eXBlcy90eXBlc1wiO1xuaW1wb3J0IHtPdXRwdXR9IGZyb20gXCIuL0xpYnJhcnkvT3V0cHV0XCI7XG5pbXBvcnQge0FkZHJlc3NJbmZvfSBmcm9tIFwibmV0XCI7XG5pbXBvcnQgYm9keVBhcnNlciA9IHJlcXVpcmUoXCJib2R5LXBhcnNlclwiKTtcblxuZXhwb3J0IHtPdXRwdXR9O1xuXG5leHBvcnQgaW50ZXJmYWNlIFNlcnZlciB7XG4gICAgLy9yZWdpb24gT25cblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBvcnQ6IG51bWJlciwgaG9zdG5hbWU6IHN0cmluZywgYmFja2xvZzogbnVtYmVyLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChwb3J0OiBudW1iZXIsIGhvc3RuYW1lOiBzdHJpbmcsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVzcG9uc2UnLCBjYWxsYmFjazogKG91dHB1dDogUlBDLlJlc3BvbnNlLklEYXRhLCByZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZXF1ZXN0JywgY2FsbGJhY2s6IChib2R5OiBSUEMuUmVxdWVzdC5JRGF0YSwgcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBvcnQ6IG51bWJlciwgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAocGF0aDogc3RyaW5nLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChoYW5kbGU6IGFueSwgbGlzdGVuaW5nTGlzdGVuZXI/OiAoKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVzcG9uc2UnLCBjYWxsYmFjazogKG91dHB1dDogUlBDLlJlc3BvbnNlLklEYXRhLCByZXE6IFJlcXVlc3QpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAoYWRkcmVzczogQWRkcmVzc0luZm8gfCBzdHJpbmcgfCBudWxsKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVxdWVzdCcsIGNhbGxiYWNrOiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncm91dGluZycsIGNhbGxiYWNrOiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAnZXJyb3InLCBjYWxsYmFjazogKGU6IEVycm9yLCByZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdlcnJvcicsIGNhbGxiYWNrOiAoZTogRXJyb3IsIHJlcTogUmVxdWVzdCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JlcXVlc3QnLCBjYWxsYmFjazogKHJlcTogUmVxdWVzdCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JvdXRpbmcnLCBjYWxsYmFjazogKHJlcTogUmVxdWVzdCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ2Vycm9yJywgY2FsbGJhY2s6IChlOiBFcnJvcikgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogc3RyaW5nLCBsaXN0ZW5lcjogKC4uLmFyZ3MpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgLy9lbmRyZWdpb25cblxuICAgIC8vcmVnaW9uIEVtaXRzXG5cbiAgICBlbWl0KGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBvcnQ6IG51bWJlciwgaG9zdG5hbWU6IHN0cmluZywgYmFja2xvZzogbnVtYmVyLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gaHR0cC5TZXJ2ZXIpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChwb3J0OiBudW1iZXIsIGhvc3RuYW1lOiBzdHJpbmcsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiBodHRwLlNlcnZlcik6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncmVzcG9uc2UnLCBjYWxsYmFjazogKG91dHB1dDogUlBDLlJlc3BvbnNlLklEYXRhLCByZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHZvaWQpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChwb3J0OiBudW1iZXIsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiBodHRwLlNlcnZlcik6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBhdGg6IHN0cmluZywgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpID0+IGh0dHAuU2VydmVyKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAoaGFuZGxlOiBhbnksIGxpc3RlbmluZ0xpc3RlbmVyPzogKCkgPT4gdm9pZCkgPT4gaHR0cC5TZXJ2ZXIpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gaHR0cC5TZXJ2ZXIpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ2Vycm9yJywgY2FsbGJhY2s6IChlOiBFcnJvciwgcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB2b2lkKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyZXF1ZXN0JywgY2FsbGJhY2s6IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHZvaWQpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JvdXRpbmcnLCBjYWxsYmFjazogKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4gdm9pZCk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAnZXJyb3InLCBjYWxsYmFjazogKGU6IEVycm9yKSA9PiB2b2lkKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6IHN0cmluZywgLi4uYXJncyk6IGJvb2xlYW47XG5cbiAgICAvL2VuZHJlZ2lvblxufVxuXG5leHBvcnQgY2xhc3MgU2VydmVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBoYW5kbGU6IEV4cHJlc3M7XG4gICAgbGlzdGVuZXI6IGh0dHAuU2VydmVyO1xuICAgIHJvdXRlczogUm91dGVzO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuaGFuZGxlID0gZXhwcmVzcygpO1xuICAgICAgICB0aGlzLnJvdXRlcyA9IG5ldyBSb3V0ZXMoKTtcbiAgICB9XG5cbiAgICBpbml0KCkge1xuICAgICAgICBsZXQgYXBwID0gdGhpcy5oYW5kbGU7XG4gICAgICAgIGFwcC5zZXQoJ3RydXN0IHByb3h5JywgdHJ1ZSk7XG5cbiAgICAgICAgLy9yZWdpb24gTWlkZGxld2FyZXNcblxuICAgICAgICAvL0ZvciByZXF1ZXN0IGVtaXR0ZXJcbiAgICAgICAgYXBwLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoe2V4dGVuZGVkOiBmYWxzZX0pKTtcbiAgICAgICAgYXBwLnVzZShib2R5UGFyc2VyLmpzb24oKSk7XG5cbiAgICAgICAgLy8gRXJyb3IgY2F0Y2ggZm9yIGJvZHlQYXJzZXJcbiAgICAgICAgYXBwLnVzZSgoZXJyLCByZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIFN5bnRheEVycm9yKSB7XG4gICAgICAgICAgICAgICAgbmV4dChuZXcgUGFyc2VFcnJvcigpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbmV4dChlcnIsIHJlcSwgcmVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9QYXJzaW5nIGJvZHlcbiAgICAgICAgYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgICAgICAgIGlmICghcmVxLmJvZHkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dChuZXcgSW52YWxpZFBhcmFtcyh7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdSZXF1ZXN0IGJvZHkgbm90IGZvdW5kLidcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoJ29iamVjdCcgIT09IHR5cGVvZiByZXEuYm9keSB8fCAhKCdzdHJpbmcnID09PSB0eXBlb2YgcmVxLmJvZHkubWV0aG9kICYmIHJlcS5ib2R5LmlkICYmIHJlcS5ib2R5LmlkKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXh0KG5ldyBJbnZhbGlkUGFyYW1zKHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgSlNPTi1SUEMgUmVxdWVzdCBCb2R5J1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vZW5kcmVnaW9uXG5cbiAgICAgICAgYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgncmVxdWVzdCcsIHJlcS5ib2R5LCByZXEsIHJlcyk7XG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgIH0pO1xuICAgICAgICBhcHAudXNlKChlcnIsIHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgICAgICBsZXQgb3V0cHV0ID0gT3V0cHV0LmdlbmVyYXRlKGVyciwgcmVxLmJvZHkgfHwge30sIHJlcyk7XG4gICAgICAgICAgICByZXNcbiAgICAgICAgICAgICAgICAuc2VuZChvdXRwdXQpXG4gICAgICAgICAgICAgICAgLmVuZCgpO1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGVyciwgcmVxLCByZXMpO1xuICAgICAgICB9KTtcblxuICAgICAgICBhcHAucG9zdCgnLz8kJywgKHJlcSwgcmVzKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3JvdXRpbmcnLCByZXEsIHJlcyk7XG4gICAgICAgICAgICBQcm9taXNlXG4gICAgICAgICAgICAgICAgLnJlc29sdmUobnVsbClcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBib2R5OiBSUEMuUmVxdWVzdC5JRGF0YSA9IHJlcS5ib2R5O1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yb3V0ZXMuY2FsbChib2R5Lm1ldGhvZCwgYm9keS5wYXJhbXMsIHJlcSwgcmVzKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy9PbiBzdWNjZXNzXG4gICAgICAgICAgICAgICAgICAgIGxldCBvdXRwdXQgPSBPdXRwdXQuZ2VuZXJhdGUocmVzdWx0LCByZXEuYm9keSB8fCB7fSwgcmVzKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdyZXNwb25zZScsIG91dHB1dCk7XG4gICAgICAgICAgICAgICAgICAgIHJlc1xuICAgICAgICAgICAgICAgICAgICAgICAgLnNlbmQob3V0cHV0KVxuICAgICAgICAgICAgICAgICAgICAgICAgLmVuZCgpO1xuICAgICAgICAgICAgICAgIH0sIChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vT24gZXJyb3JcbiAgICAgICAgICAgICAgICAgICAgbGV0IG91dHB1dCA9IE91dHB1dC5nZW5lcmF0ZShlLCByZXEuYm9keSB8fCB7fSwgcmVzKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzXG4gICAgICAgICAgICAgICAgICAgICAgICAuc2VuZChvdXRwdXQpXG4gICAgICAgICAgICAgICAgICAgICAgICAuZW5kKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlLCByZXEsIHJlcyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBhcHAuZ2V0KCcvPyQnLCAocmVxLCByZXMpID0+IHtcbiAgICAgICAgICAgIHRocm93IG5ldyBQYXJzZUVycm9yKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgbGlzdGVuKHBvcnQ6IG51bWJlciwgaG9zdD86IHN0cmluZyk6IFByb21pc2U8aHR0cC5TZXJ2ZXI+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChzdWNjLCBlcnIpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmxpc3RlbmVyID0gdGhpcy5oYW5kbGUubGlzdGVuKHBvcnQsIGhvc3QsICgpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgYWRkcmVzcyA9IHRoaXMubGlzdGVuZXIuYWRkcmVzcygpO1xuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgncmVhZHknLCBhZGRyZXNzKTtcbiAgICAgICAgICAgICAgICAvL1RPRE86IFRleWZpaydlIHNvclxuICAgICAgICAgICAgICAgIHN1Y2ModGhpcy5saXN0ZW5lcik7XG4gICAgICAgICAgICB9KS5vbignZXJyb3InLCBlcnIpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=