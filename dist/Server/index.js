"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const Routes_1 = require("./Library/Routes");
const ParseError_1 = require("./Errors/ParseError");
const events_1 = require("events");
const InvalidParams_1 = require("./Errors/InvalidParams");
const Output_1 = require("./Library/Output");
exports.Output = Output_1.Output;
const bodyParser = require("body-parser");
class Server extends events_1.EventEmitter {
    constructor() {
        super();
        this.handle = express_1.default();
        this.routes = new Routes_1.Routes();
    }
    init() {
        let app = this.handle;
        app.set('trust proxy', true);
        //region Middlewares
        //For request emitter
        app.use(bodyParser.urlencoded({ extended: false }));
        app.use(bodyParser.json());
        // Error catch for bodyParser
        app.use((err, req, res, next) => {
            if (err instanceof SyntaxError) {
                next(new ParseError_1.ParseError());
            }
            else {
                next(err, req, res);
            }
        });
        //Parsing body
        app.use((req, res, next) => {
            if (!req.body) {
                return next(new InvalidParams_1.InvalidParams({
                    message: 'Request body not found.'
                }));
            }
            if ('object' !== typeof req.body || !('string' === typeof req.body.method && req.body.id && req.body.id)) {
                return next(new InvalidParams_1.InvalidParams({
                    message: 'Invalid JSON-RPC Request Body'
                }));
            }
            next();
        });
        //endregion
        app.use((req, res, next) => {
            this.emit('request', req.body, req, res);
            next();
        });
        app.use((err, req, res, next) => {
            let output = Output_1.Output.generate(err, req.body || {}, res);
            res
                .send(output)
                .end();
            this.emit('error', err, req, res);
        });
        app.post('/?$', (req, res) => {
            this.emit('routing', req, res);
            Promise
                .resolve(null)
                .then(() => {
                let body = req.body;
                return this.routes.call(body.method, body.params, req, res);
            })
                .then((result) => {
                //On success
                let output = Output_1.Output.generate(result, req.body || {}, res);
                this.emit('response', output);
                res
                    .send(output)
                    .end();
            }, (e) => {
                //On error
                let output = Output_1.Output.generate(e, req.body || {}, res);
                res
                    .send(output)
                    .end();
                this.emit('error', e, req, res);
            });
        });
        app.get('/?$', (req, res) => {
            throw new ParseError_1.ParseError();
        });
    }
    listen(port, host) {
        return new Promise((succ, err) => {
            return this.listener = this.handle.listen(port, host, () => {
                let address = this.listener.address();
                this.emit('ready', address);
                //TODO: Teyfik'e sor
                succ(this.listener);
            }).on('error', err);
        });
    }
}
exports.Server = Server;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvU2VydmVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsc0RBQWtEO0FBQ2xELDZDQUF3QztBQUN4QyxvREFBK0M7QUFDL0MsbUNBQW9DO0FBRXBDLDBEQUFxRDtBQUVyRCw2Q0FBd0M7QUFJaEMsaUJBSkEsZUFBTSxDQUlBO0FBRmQsMENBQTJDO0FBZ0YzQyxNQUFhLE1BQU8sU0FBUSxxQkFBWTtJQUtwQztRQUNJLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxpQkFBTyxFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLGVBQU0sRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFRCxJQUFJO1FBQ0EsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUN0QixHQUFHLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUU3QixvQkFBb0I7UUFFcEIscUJBQXFCO1FBQ3JCLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxFQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUUzQiw2QkFBNkI7UUFDN0IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQzVCLElBQUksR0FBRyxZQUFZLFdBQVcsRUFBRTtnQkFDNUIsSUFBSSxDQUFDLElBQUksdUJBQVUsRUFBRSxDQUFDLENBQUM7YUFDMUI7aUJBQU07Z0JBQ0gsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7YUFDdkI7UUFDTCxDQUFDLENBQUMsQ0FBQztR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Q1osR0FBRyxFQUFFLENBQUM7Z0JBQ1gsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNwQyxDQUFDLENBQUMsQ0FBQztRQUNYLENBQUMsQ0FBQyxDQUFDO1FBQ0gsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDeEIsTUFBTSxJQUFJLHVCQUFVLEVBQUUsQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFHRCxNQUFNLENBQUMsSUFBWSxFQUFFLElBQWE7UUFDOUIsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUM3QixPQUFPLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUU7Z0JBQ3ZELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ3RDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUM1QixvQkFBb0I7Z0JBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDeEIsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN4QixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQWxHRCx3QkFrR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcywge0V4cHJlc3MsIFJlcXVlc3R9IGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQge1JvdXRlc30gZnJvbSBcIi4vTGlicmFyeS9Sb3V0ZXNcIjtcbmltcG9ydCB7UGFyc2VFcnJvcn0gZnJvbSBcIi4vRXJyb3JzL1BhcnNlRXJyb3JcIjtcbmltcG9ydCB7RXZlbnRFbWl0dGVyfSBmcm9tIFwiZXZlbnRzXCI7XG5pbXBvcnQgKiBhcyBodHRwIGZyb20gXCJodHRwXCI7XG5pbXBvcnQge0ludmFsaWRQYXJhbXN9IGZyb20gXCIuL0Vycm9ycy9JbnZhbGlkUGFyYW1zXCI7XG5pbXBvcnQge1JQQ30gZnJvbSBcIi4uL0B0eXBlcy90eXBlc1wiO1xuaW1wb3J0IHtPdXRwdXR9IGZyb20gXCIuL0xpYnJhcnkvT3V0cHV0XCI7XG5pbXBvcnQge0FkZHJlc3NJbmZvfSBmcm9tIFwibmV0XCI7XG5pbXBvcnQgYm9keVBhcnNlciA9IHJlcXVpcmUoXCJib2R5LXBhcnNlclwiKTtcblxuZXhwb3J0IHtPdXRwdXR9O1xuXG5leHBvcnQgaW50ZXJmYWNlIFNlcnZlciB7XG4gICAgLy9yZWdpb24gT25cblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBvcnQ6IG51bWJlciwgaG9zdG5hbWU6IHN0cmluZywgYmFja2xvZzogbnVtYmVyLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChwb3J0OiBudW1iZXIsIGhvc3RuYW1lOiBzdHJpbmcsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVzcG9uc2UnLCBjYWxsYmFjazogKG91dHB1dDogUlBDLlJlc3BvbnNlLklFcnJvciwgcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVzcG9uc2UnLCBjYWxsYmFjazogKG91dHB1dDogUlBDLlJlc3BvbnNlLklEYXRhLCByZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZXF1ZXN0JywgY2FsbGJhY2s6IChib2R5OiBSUEMuUmVxdWVzdC5JRGF0YSwgcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBvcnQ6IG51bWJlciwgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAocGF0aDogc3RyaW5nLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChoYW5kbGU6IGFueSwgbGlzdGVuaW5nTGlzdGVuZXI/OiAoKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVzcG9uc2UnLCBjYWxsYmFjazogKG91dHB1dDogUlBDLlJlc3BvbnNlLklFcnJvciwgcmVxOiBSZXF1ZXN0KSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVzcG9uc2UnLCBjYWxsYmFjazogKG91dHB1dDogUlBDLlJlc3BvbnNlLklEYXRhLCByZXE6IFJlcXVlc3QpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAoYWRkcmVzczogQWRkcmVzc0luZm8gfCBzdHJpbmcgfCBudWxsKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVxdWVzdCcsIGNhbGxiYWNrOiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncm91dGluZycsIGNhbGxiYWNrOiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAnZXJyb3InLCBjYWxsYmFjazogKGU6IEVycm9yLCByZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdlcnJvcicsIGNhbGxiYWNrOiAoZTogRXJyb3IsIHJlcTogUmVxdWVzdCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JlcXVlc3QnLCBjYWxsYmFjazogKHJlcTogUmVxdWVzdCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JvdXRpbmcnLCBjYWxsYmFjazogKHJlcTogUmVxdWVzdCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ2Vycm9yJywgY2FsbGJhY2s6IChlOiBFcnJvcikgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogc3RyaW5nLCBsaXN0ZW5lcjogKC4uLmFyZ3MpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgLy9lbmRyZWdpb25cblxuICAgIC8vcmVnaW9uIEVtaXRzXG5cbiAgICBlbWl0KGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBvcnQ6IG51bWJlciwgaG9zdG5hbWU6IHN0cmluZywgYmFja2xvZzogbnVtYmVyLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gaHR0cC5TZXJ2ZXIpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChwb3J0OiBudW1iZXIsIGhvc3RuYW1lOiBzdHJpbmcsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiBodHRwLlNlcnZlcik6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncmVzcG9uc2UnLCBjYWxsYmFjazogKG91dHB1dDogUlBDLlJlc3BvbnNlLklFcnJvciwgcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB2b2lkKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyZXNwb25zZScsIGNhbGxiYWNrOiAob3V0cHV0OiBSUEMuUmVzcG9uc2UuSURhdGEsIHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4gdm9pZCk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBvcnQ6IG51bWJlciwgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpID0+IGh0dHAuU2VydmVyKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAocGF0aDogc3RyaW5nLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gaHR0cC5TZXJ2ZXIpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChoYW5kbGU6IGFueSwgbGlzdGVuaW5nTGlzdGVuZXI/OiAoKSA9PiB2b2lkKSA9PiBodHRwLlNlcnZlcik6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiBodHRwLlNlcnZlcik6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAnZXJyb3InLCBjYWxsYmFjazogKGU6IEVycm9yLCByZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHZvaWQpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlcXVlc3QnLCBjYWxsYmFjazogKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4gdm9pZCk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncm91dGluZycsIGNhbGxiYWNrOiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB2b2lkKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdlcnJvcicsIGNhbGxiYWNrOiAoZTogRXJyb3IpID0+IHZvaWQpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogc3RyaW5nLCAuLi5hcmdzKTogYm9vbGVhbjtcblxuICAgIC8vZW5kcmVnaW9uXG59XG5cbmV4cG9ydCBjbGFzcyBTZXJ2ZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGhhbmRsZTogRXhwcmVzcztcbiAgICBsaXN0ZW5lcjogaHR0cC5TZXJ2ZXI7XG4gICAgcm91dGVzOiBSb3V0ZXM7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5oYW5kbGUgPSBleHByZXNzKCk7XG4gICAgICAgIHRoaXMucm91dGVzID0gbmV3IFJvdXRlcygpO1xuICAgIH1cblxuICAgIGluaXQoKSB7XG4gICAgICAgIGxldCBhcHAgPSB0aGlzLmhhbmRsZTtcbiAgICAgICAgYXBwLnNldCgndHJ1c3QgcHJveHknLCB0cnVlKTtcblxuICAgICAgICAvL3JlZ2lvbiBNaWRkbGV3YXJlc1xuXG4gICAgICAgIC8vRm9yIHJlcXVlc3QgZW1pdHRlclxuICAgICAgICBhcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7ZXh0ZW5kZWQ6IGZhbHNlfSkpO1xuICAgICAgICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKTtcblxuICAgICAgICAvLyBFcnJvciBjYXRjaCBmb3IgYm9keVBhcnNlclxuICAgICAgICBhcHAudXNlKChlcnIsIHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgU3ludGF4RXJyb3IpIHtcbiAgICAgICAgICAgICAgICBuZXh0KG5ldyBQYXJzZUVycm9yKCkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuZXh0KGVyciwgcmVxLCByZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvL1BhcnNpbmcgYm9keVxuICAgICAgICBhcHAudXNlKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFyZXEuYm9keSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXh0KG5ldyBJbnZhbGlkUGFyYW1zKHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ1JlcXVlc3QgYm9keSBub3QgZm91bmQuJ1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICgnb2JqZWN0JyAhPT0gdHlwZW9mIHJlcS5ib2R5IHx8ICEoJ3N0cmluZycgPT09IHR5cGVvZiByZXEuYm9keS5tZXRob2QgJiYgcmVxLmJvZHkuaWQgJiYgcmVxLmJvZHkuaWQpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5leHQobmV3IEludmFsaWRQYXJhbXMoe1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBKU09OLVJQQyBSZXF1ZXN0IEJvZHknXG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbmV4dCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgLy9lbmRyZWdpb25cblxuICAgICAgICBhcHAudXNlKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdyZXF1ZXN0JywgcmVxLmJvZHksIHJlcSwgcmVzKTtcbiAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGFwcC51c2UoKGVyciwgcmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgICAgICAgIGxldCBvdXRwdXQgPSBPdXRwdXQuZ2VuZXJhdGUoZXJyLCByZXEuYm9keSB8fCB7fSwgcmVzKTtcbiAgICAgICAgICAgIHJlc1xuICAgICAgICAgICAgICAgIC5zZW5kKG91dHB1dClcbiAgICAgICAgICAgICAgICAuZW5kKCk7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyLCByZXEsIHJlcyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGFwcC5wb3N0KCcvPyQnLCAocmVxLCByZXMpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgncm91dGluZycsIHJlcSwgcmVzKTtcbiAgICAgICAgICAgIFByb21pc2VcbiAgICAgICAgICAgICAgICAucmVzb2x2ZShudWxsKVxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGJvZHk6IFJQQy5SZXF1ZXN0LklEYXRhID0gcmVxLmJvZHk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJvdXRlcy5jYWxsKGJvZHkubWV0aG9kLCBib2R5LnBhcmFtcywgcmVxLCByZXMpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvL09uIHN1Y2Nlc3NcbiAgICAgICAgICAgICAgICAgICAgbGV0IG91dHB1dCA9IE91dHB1dC5nZW5lcmF0ZShyZXN1bHQsIHJlcS5ib2R5IHx8IHt9LCByZXMpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ3Jlc3BvbnNlJywgb3V0cHV0KTtcbiAgICAgICAgICAgICAgICAgICAgcmVzXG4gICAgICAgICAgICAgICAgICAgICAgICAuc2VuZChvdXRwdXQpXG4gICAgICAgICAgICAgICAgICAgICAgICAuZW5kKCk7XG4gICAgICAgICAgICAgICAgfSwgKGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy9PbiBlcnJvclxuICAgICAgICAgICAgICAgICAgICBsZXQgb3V0cHV0ID0gT3V0cHV0LmdlbmVyYXRlKGUsIHJlcS5ib2R5IHx8IHt9LCByZXMpO1xuICAgICAgICAgICAgICAgICAgICByZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zZW5kKG91dHB1dClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5lbmQoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGUsIHJlcSwgcmVzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGFwcC5nZXQoJy8/JCcsIChyZXEsIHJlcykgPT4ge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFBhcnNlRXJyb3IoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICBsaXN0ZW4ocG9ydDogbnVtYmVyLCBob3N0Pzogc3RyaW5nKTogUHJvbWlzZTxodHRwLlNlcnZlcj4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHN1Y2MsIGVycikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubGlzdGVuZXIgPSB0aGlzLmhhbmRsZS5saXN0ZW4ocG9ydCwgaG9zdCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBhZGRyZXNzID0gdGhpcy5saXN0ZW5lci5hZGRyZXNzKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdyZWFkeScsIGFkZHJlc3MpO1xuICAgICAgICAgICAgICAgIC8vVE9ETzogVGV5ZmlrJ2Ugc29yXG4gICAgICAgICAgICAgICAgc3VjYyh0aGlzLmxpc3RlbmVyKTtcbiAgICAgICAgICAgIH0pLm9uKCdlcnJvcicsIGVycik7XG4gICAgICAgIH0pO1xuICAgIH1cbn0iXX0=