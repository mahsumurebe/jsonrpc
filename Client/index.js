"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const axios_1 = __importDefault(require("axios"));
const qs_1 = require("qs");
const Response_1 = require("./Abstracts/Response");
const ErrorResponse_1 = require("./Abstracts/ErrorResponse");
exports.ErrorResponse = ErrorResponse_1.ErrorResponse;
const __1 = require("..");
class Client {
    constructor(config) {
        this.permanentArguments = [];
        config = {
            headers: {
                'Content-Type': 'application/json'
            },
            ...config,
            ...{ paramsSerializer: qs_1.stringify }
        };
        if (config.baseURL) {
            let parsedUrl = new URL(config.baseURL);
            if (parsedUrl.username) {
                let credentials = {
                    username: parsedUrl.username,
                    password: parsedUrl.password,
                };
                delete parsedUrl.username;
                delete parsedUrl.password;
                config['auth'] = credentials;
                config['baseURL'] = parsedUrl.href;
            }
        }
        this.axios = axios_1.default.create(config);
    }
    mapResponse(response, multiple) {
        if (response instanceof Array) {
            return response.map((item) => {
                return this.mapResponse(item, true);
            });
        }
        else {
            if (!!response.error) {
                if (multiple) {
                    return new ErrorResponse_1.ErrorResponse(response.error);
                }
                else {
                    // @ts-ignore
                    let data = response.data || response.error.data || null;
                    let errC;
                    switch (response.error.code || -32603) {
                        case -32603:
                            errC = __1.InternalError;
                            break;
                        case -32602:
                            errC = __1.InvalidParams;
                            break;
                        case -32600:
                            errC = __1.InvalidRequest;
                            break;
                        case -32601:
                            errC = __1.MethodNotFound;
                            break;
                        case -32700:
                            errC = __1.ParseError;
                            break;
                        default:
                            errC = __1.ServerError;
                            break;
                    }
                    throw new errC(data, response.error.message || 'Internal error', response.error.code || -32603);
                }
            }
            else {
                if (multiple) {
                    let result = new Response_1.Response();
                    result.code = response.code || undefined;
                    result.id = response.id || undefined;
                    result.jsonrpc = response.jsonrpc || undefined;
                    result.result = response.result || response;
                    return result;
                }
                else {
                    if (typeof response !== 'object' || !('result' in response)) {
                        throw new __1.ParseError(response);
                    }
                    return response.result;
                }
            }
        }
    }
    async request(url, params) {
        return this.axios
            .post(url, this.reduceParams(params || this.defaultParams), {})
            .then(response => (response ? response.data : response))
            .catch((err) => {
            if (err.response && err.response.data) {
                return this.mapResponse(err.response.data);
            }
            throw err;
        });
    }
    rpc(...args) {
        let data = args.flat(Infinity)
            .map((item, i) => {
            return {
                id: ++i,
                jsonrpc: '2.0',
                params: {},
                ...item,
            };
        });
        if (data.length === 1 && !(args[0] instanceof Array || args.length > 1)) {
            data = data[0];
        }
        return this
            .request('', data)
            .then(data => {
            return this.mapResponse(data);
        })
            .then((data) => data);
    }
    reduceParams(params) {
        for (const args of this.permanentArguments) {
            if (params instanceof Array) {
                params = params.concat(args);
            }
            else if (typeof params === 'object' && args.constructor.name === 'Object') {
                for (let k in args) {
                    // noinspection JSUnfilteredForInLoop
                    params[k] = args[k];
                }
            }
        }
        return params;
    }
    addPermanentArgument(params) {
        if (params instanceof Array) {
            this.permanentArguments = this.permanentArguments.concat(params);
        }
        else {
            this.permanentArguments.push(params);
        }
        return this;
    }
}
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvQ2xpZW50L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsa0RBQTBGO0FBQzFGLDJCQUFpRDtBQUNqRCxtREFBOEM7QUFDOUMsNkRBQXdEO0FBT2hELHdCQVBBLDZCQUFhLENBT0E7QUFOckIsMEJBQThHO0FBVTlHLE1BQWEsTUFBTTtJQUtmLFlBQVksTUFBcUI7UUFGakMsdUJBQWtCLEdBQUcsRUFBRSxDQUFDO1FBR3BCLE1BQU0sR0FBRztZQUNMLE9BQU8sRUFBRTtnQkFDTCxjQUFjLEVBQUUsa0JBQWtCO2FBQ3JDO1lBQ0QsR0FBRyxNQUFNO1lBQ1QsR0FBRyxFQUFDLGdCQUFnQixFQUFoQixjQUFnQixFQUFDO1NBQ3hCLENBQUM7UUFFRixJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7WUFDaEIsSUFBSSxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3hDLElBQUksU0FBUyxDQUFDLFFBQVEsRUFBRTtnQkFDcEIsSUFBSSxXQUFXLEdBQUc7b0JBQ2QsUUFBUSxFQUFFLFNBQVMsQ0FBQyxRQUFRO29CQUM1QixRQUFRLEVBQUUsU0FBUyxDQUFDLFFBQVE7aUJBQy9CLENBQUM7Z0JBQ0YsT0FBTyxTQUFTLENBQUMsUUFBUSxDQUFDO2dCQUMxQixPQUFPLFNBQVMsQ0FBQyxRQUFRLENBQUM7Z0JBQzFCLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxXQUFXLENBQUM7Z0JBQzdCLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDO2FBQ3RDO1NBQ0o7UUFDRCxJQUFJLENBQUMsS0FBSyxHQUFHLGVBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUlELFdBQVcsQ0FBSSxRQUF1QyxFQUFFLFFBQWtCO1FBQ3RFLElBQUksUUFBUSxZQUFZLEtBQUssRUFBRTtZQUMzQixPQUFPLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFrQixFQUFFLEVBQUU7Z0JBQ3ZDLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBSSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDM0MsQ0FBQyxDQUFDLENBQUM7U0FDTjthQUFNO1lBQ0gsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRTtnQkFDbEIsSUFBSSxRQUFRLEVBQUU7b0JBQ1YsT0FBTyxJQUFJLDZCQUFhLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUM1QztxQkFBTTtvQkFDSCxhQUFhO29CQUNiLElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDO29CQUV4RCxJQUFJLElBQUksQ0FBQztvQkFFVCxRQUFRLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO3dCQUNuQyxLQUFLLENBQUMsS0FBSzs0QkFDUCxJQUFJLEdBQUcsaUJBQWEsQ0FBQzs0QkFDckIsTUFBTTt3QkFDVixLQUFLLENBQUMsS0FBSzs0QkFDUCxJQUFJLEdBQUcsaUJBQWEsQ0FBQzs0QkFDckIsTUFBTTt3QkFDVixLQUFLLENBQUMsS0FBSzs0QkFDUCxJQUFJLEdBQUcsa0JBQWMsQ0FBQzs0QkFDdEIsTUFBTTt3QkFDVixLQUFLLENBQUMsS0FBSzs0QkFDUCxJQUFJLEdBQUcsa0JBQWMsQ0FBQzs0QkFDdEIsTUFBTTt3QkFDVixLQUFLLENBQUMsS0FBSzs0QkFDUCxJQUFJLEdBQUcsY0FBVSxDQUFDOzRCQUNsQixNQUFNO3dCQUNWOzRCQUNJLElBQUksR0FBRyxlQUFXLENBQUM7NEJBQ25CLE1BQU07cUJBQ2I7b0JBRUQsTUFBTSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksZ0JBQWdCLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDbkc7YUFDSjtpQkFBTTtnQkFDSCxJQUFJLFFBQVEsRUFBRTtvQkFDVixJQUFJLE1BQU0sR0FBRyxJQUFJLG1CQUFRLEVBQUssQ0FBQztvQkFDL0IsTUFBTSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxJQUFJLFNBQVMsQ0FBQztvQkFDekMsTUFBTSxDQUFDLEVBQUUsR0FBRyxRQUFRLENBQUMsRUFBRSxJQUFJLFNBQVMsQ0FBQztvQkFDckMsTUFBTSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxJQUFJLFNBQVMsQ0FBQztvQkFDL0MsTUFBTSxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUMsTUFBTSxJQUFJLFFBQVEsQ0FBQztvQkFDNUMsT0FBTyxNQUFNLENBQUM7aUJBQ2pCO3FCQUFNO29CQUNILElBQUksT0FBTyxRQUFRLEtBQUssUUFBUSxJQUFJLENBQUMsQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLEVBQUU7d0JBQ3pELE1BQU0sSUFBSSxjQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7cUJBQ2xDO29CQUNELE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQztpQkFDMUI7YUFDSjtTQUNKO0lBQ0wsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLE1BQU07UUFDckIsT0FBTyxJQUFJLENBQUMsS0FBSzthQUNaLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsQ0FBQzthQUM5RCxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDdkQsS0FBSyxDQUFDLENBQUMsR0FBZSxFQUFFLEVBQUU7WUFDdkIsSUFBSSxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFO2dCQUNuQyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUM5QztZQUNELE1BQU0sR0FBRyxDQUFDO1FBQ2QsQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDO0lBS0QsR0FBRyxDQUFJLEdBQUcsSUFBdUM7UUFDN0MsSUFBSSxJQUFJLEdBQW9DLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO2FBQzFELEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNiLE9BQU87Z0JBQ0gsRUFBRSxFQUFFLEVBQUUsQ0FBQztnQkFDUCxPQUFPLEVBQUUsS0FBSztnQkFDZCxNQUFNLEVBQUUsRUFBRTtnQkFDVixHQUFHLElBQUk7YUFDVixDQUFDO1FBQ04sQ0FBQyxDQUFDLENBQUM7UUFFUCxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFlBQVksS0FBSyxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEVBQUU7WUFDckUsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNsQjtRQUVELE9BQU8sSUFBSTthQUNOLE9BQU8sQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDO2FBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNULE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBSSxJQUFXLENBQUMsQ0FBQztRQUM1QyxDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFTyxZQUFZLENBQUMsTUFBa0I7UUFDbkMsS0FBSyxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDeEMsSUFBSSxNQUFNLFlBQVksS0FBSyxFQUFFO2dCQUN6QixNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNoQztpQkFBTSxJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7Z0JBQ3pFLEtBQUssSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFO29CQUNoQixxQ0FBcUM7b0JBQ3JDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ3ZCO2FBQ0o7U0FDSjtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxvQkFBb0IsQ0FBQyxNQUFrQjtRQUNuQyxJQUFJLE1BQU0sWUFBWSxLQUFLLEVBQUU7WUFDekIsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDcEU7YUFBTTtZQUNILElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDeEM7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0NBQ0o7QUFwSkQsd0JBb0pDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEF4aW9zLCB7QXhpb3NFcnJvciwgQXhpb3NJbnN0YW5jZSwgQXhpb3NSZXF1ZXN0Q29uZmlnLCBBeGlvc1Jlc3BvbnNlfSBmcm9tIFwiYXhpb3NcIjtcbmltcG9ydCB7c3RyaW5naWZ5IGFzIHBhcmFtc1NlcmlhbGl6ZXJ9IGZyb20gJ3FzJztcbmltcG9ydCB7UmVzcG9uc2V9IGZyb20gXCIuL0Fic3RyYWN0cy9SZXNwb25zZVwiO1xuaW1wb3J0IHtFcnJvclJlc3BvbnNlfSBmcm9tIFwiLi9BYnN0cmFjdHMvRXJyb3JSZXNwb25zZVwiO1xuaW1wb3J0IHtJbnRlcm5hbEVycm9yLCBJbnZhbGlkUGFyYW1zLCBJbnZhbGlkUmVxdWVzdCwgTWV0aG9kTm90Rm91bmQsIFBhcnNlRXJyb3IsIFJQQywgU2VydmVyRXJyb3J9IGZyb20gXCIuLlwiO1xuXG5leHBvcnQgdHlwZSBDbGllbnRPcHRpb25zID0gQXhpb3NSZXF1ZXN0Q29uZmlnO1xuXG50eXBlIFRNYXBSZXNvdXJjZSA9IFJQQy5SZXNwb25zZS5JRGF0YTtcbnR5cGUgVE1hcFJldHVyblR5cGU8VD4gPSBSZXNwb25zZTxUPiB8IEVycm9yUmVzcG9uc2U7XG5leHBvcnQge0Vycm9yUmVzcG9uc2V9O1xuXG50eXBlIFRQYXJhbVR5cGUgPSBBcnJheTxhbnk+IHwge307XG5cbmV4cG9ydCBjbGFzcyBDbGllbnQge1xuICAgIGF4aW9zOiBBeGlvc0luc3RhbmNlO1xuICAgIGRlZmF1bHRQYXJhbXM6IFRQYXJhbVR5cGU7XG4gICAgcGVybWFuZW50QXJndW1lbnRzID0gW107XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IENsaWVudE9wdGlvbnMpIHtcbiAgICAgICAgY29uZmlnID0ge1xuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAuLi5jb25maWcsXG4gICAgICAgICAgICAuLi57cGFyYW1zU2VyaWFsaXplcn1cbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoY29uZmlnLmJhc2VVUkwpIHtcbiAgICAgICAgICAgIGxldCBwYXJzZWRVcmwgPSBuZXcgVVJMKGNvbmZpZy5iYXNlVVJMKTtcbiAgICAgICAgICAgIGlmIChwYXJzZWRVcmwudXNlcm5hbWUpIHtcbiAgICAgICAgICAgICAgICBsZXQgY3JlZGVudGlhbHMgPSB7XG4gICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiBwYXJzZWRVcmwudXNlcm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBwYXJzZWRVcmwucGFzc3dvcmQsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBkZWxldGUgcGFyc2VkVXJsLnVzZXJuYW1lO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBwYXJzZWRVcmwucGFzc3dvcmQ7XG4gICAgICAgICAgICAgICAgY29uZmlnWydhdXRoJ10gPSBjcmVkZW50aWFscztcbiAgICAgICAgICAgICAgICBjb25maWdbJ2Jhc2VVUkwnXSA9IHBhcnNlZFVybC5ocmVmO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuYXhpb3MgPSBBeGlvcy5jcmVhdGUoY29uZmlnKTtcbiAgICB9XG5cbiAgICBtYXBSZXNwb25zZTxUPihyZXNwb25zZTogVE1hcFJlc291cmNlW10sIG11bHRpcGxlPzogYm9vbGVhbik6IFRNYXBSZXR1cm5UeXBlPFQ+W107XG4gICAgbWFwUmVzcG9uc2U8VD4ocmVzcG9uc2U6IFRNYXBSZXNvdXJjZSwgbXVsdGlwbGU/OiBib29sZWFuKTogVE1hcFJldHVyblR5cGU8VD47XG4gICAgbWFwUmVzcG9uc2U8VD4ocmVzcG9uc2U6IFRNYXBSZXNvdXJjZSB8IFRNYXBSZXNvdXJjZVtdLCBtdWx0aXBsZT86IGJvb2xlYW4pOiBUTWFwUmV0dXJuVHlwZTxUPiB8IFRNYXBSZXR1cm5UeXBlPFQ+W10ge1xuICAgICAgICBpZiAocmVzcG9uc2UgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLm1hcCgoaXRlbTogVE1hcFJlc291cmNlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwUmVzcG9uc2U8VD4oaXRlbSwgdHJ1ZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghIXJlc3BvbnNlLmVycm9yKSB7XG4gICAgICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRXJyb3JSZXNwb25zZShyZXNwb25zZS5lcnJvcik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICAgICBsZXQgZGF0YSA9IHJlc3BvbnNlLmRhdGEgfHwgcmVzcG9uc2UuZXJyb3IuZGF0YSB8fCBudWxsO1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBlcnJDO1xuXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocmVzcG9uc2UuZXJyb3IuY29kZSB8fCAtMzI2MDMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgLTMyNjAzOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVyckMgPSBJbnRlcm5hbEVycm9yO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAtMzI2MDI6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyQyA9IEludmFsaWRQYXJhbXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIC0zMjYwMDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJDID0gSW52YWxpZFJlcXVlc3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIC0zMjYwMTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJDID0gTWV0aG9kTm90Rm91bmQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIC0zMjcwMDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJDID0gUGFyc2VFcnJvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyQyA9IFNlcnZlckVycm9yO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IGVyckMoZGF0YSwgcmVzcG9uc2UuZXJyb3IubWVzc2FnZSB8fCAnSW50ZXJuYWwgZXJyb3InLCByZXNwb25zZS5lcnJvci5jb2RlIHx8IC0zMjYwMyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG5ldyBSZXNwb25zZTxUPigpO1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQuY29kZSA9IHJlc3BvbnNlLmNvZGUgfHwgdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQuaWQgPSByZXNwb25zZS5pZCB8fCB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5qc29ucnBjID0gcmVzcG9uc2UuanNvbnJwYyB8fCB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5yZXN1bHQgPSByZXNwb25zZS5yZXN1bHQgfHwgcmVzcG9uc2U7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXNwb25zZSAhPT0gJ29iamVjdCcgfHwgISgncmVzdWx0JyBpbiByZXNwb25zZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBQYXJzZUVycm9yKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVzdWx0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHJlcXVlc3QodXJsLCBwYXJhbXMpOiBQcm9taXNlPEF4aW9zUmVzcG9uc2UgfCBBeGlvc1Jlc3BvbnNlW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXhpb3NcbiAgICAgICAgICAgIC5wb3N0KHVybCwgdGhpcy5yZWR1Y2VQYXJhbXMocGFyYW1zIHx8IHRoaXMuZGVmYXVsdFBhcmFtcyksIHt9KVxuICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gKHJlc3BvbnNlID8gcmVzcG9uc2UuZGF0YSA6IHJlc3BvbnNlKSlcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyOiBBeGlvc0Vycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVyci5yZXNwb25zZSAmJiBlcnIucmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tYXBSZXNwb25zZShlcnIucmVzcG9uc2UuZGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJwYzxUPihhcmdzOiBSUEMuSVBheWxvYWQpOiBQcm9taXNlPFQ+O1xuICAgIHJwYzxUPihhcmcxOiBSUEMuSVBheWxvYWQsIC4uLmFyZ3M6IFJQQy5JUGF5bG9hZFtdKTogUHJvbWlzZTxUTWFwUmV0dXJuVHlwZTxUPltdPjtcbiAgICBycGM8VD4oYXJnczogUlBDLklQYXlsb2FkW10pOiBQcm9taXNlPFRNYXBSZXR1cm5UeXBlPFQ+W10+O1xuICAgIHJwYzxUPiguLi5hcmdzOiAoUlBDLklQYXlsb2FkIHwgUlBDLklQYXlsb2FkW10pW10pOiBQcm9taXNlPFQ+IHtcbiAgICAgICAgbGV0IGRhdGE6IChSUEMuSVBheWxvYWQgfCBSUEMuSVBheWxvYWRbXSkgPSBhcmdzLmZsYXQoSW5maW5pdHkpXG4gICAgICAgICAgICAubWFwKChpdGVtLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6ICsraSxcbiAgICAgICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtczoge30sXG4gICAgICAgICAgICAgICAgICAgIC4uLml0ZW0sXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMSAmJiAhKGFyZ3NbMF0gaW5zdGFuY2VvZiBBcnJheSB8fCBhcmdzLmxlbmd0aCA+IDEpKSB7XG4gICAgICAgICAgICBkYXRhID0gZGF0YVswXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzXG4gICAgICAgICAgICAucmVxdWVzdCgnJywgZGF0YSlcbiAgICAgICAgICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcFJlc3BvbnNlPFQ+KGRhdGEgYXMgYW55KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoZGF0YTogYW55KSA9PiBkYXRhKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlZHVjZVBhcmFtcyhwYXJhbXM6IFRQYXJhbVR5cGUpOiBUUGFyYW1UeXBlIHtcbiAgICAgICAgZm9yIChjb25zdCBhcmdzIG9mIHRoaXMucGVybWFuZW50QXJndW1lbnRzKSB7XG4gICAgICAgICAgICBpZiAocGFyYW1zIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMuY29uY2F0KGFyZ3MpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGFyYW1zID09PSAnb2JqZWN0JyAmJiBhcmdzLmNvbnN0cnVjdG9yLm5hbWUgPT09ICdPYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgayBpbiBhcmdzKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIG5vaW5zcGVjdGlvbiBKU1VuZmlsdGVyZWRGb3JJbkxvb3BcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2tdID0gYXJnc1trXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHBhcmFtcztcbiAgICB9XG5cbiAgICBhZGRQZXJtYW5lbnRBcmd1bWVudChwYXJhbXM6IFRQYXJhbVR5cGUpOiB0aGlzIHtcbiAgICAgICAgaWYgKHBhcmFtcyBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICB0aGlzLnBlcm1hbmVudEFyZ3VtZW50cyA9IHRoaXMucGVybWFuZW50QXJndW1lbnRzLmNvbmNhdChwYXJhbXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wZXJtYW5lbnRBcmd1bWVudHMucHVzaChwYXJhbXMpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbn1cbiJdfQ==