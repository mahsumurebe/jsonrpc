"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const axios_1 = __importDefault(require("axios"));
const qs_1 = require("qs");
const Response_1 = require("./Abstracts/Response");
const ErrorResponse_1 = require("./Abstracts/ErrorResponse");
exports.ErrorResponse = ErrorResponse_1.ErrorResponse;
const __1 = require("..");
class Client {
    constructor(config) {
        this.defaultParams = {};
        this.permanentArguments = [];
        config = {
            headers: {
                'Content-Type': 'application/json'
            },
            ...config,
            ...{ paramsSerializer: qs_1.stringify }
        };
        if (config.baseURL) {
            let parsedUrl = new URL(config.baseURL);
            if (parsedUrl.username) {
                let credentials = {
                    username: parsedUrl.username,
                    password: parsedUrl.password,
                };
                delete parsedUrl.username;
                delete parsedUrl.password;
                config['auth'] = credentials;
                config['baseURL'] = parsedUrl.href;
            }
        }
        this.axios = axios_1.default.create(config);
    }
    errorHandler(response, multiple) {
        if (!!response.error) {
            if (multiple) {
                return new ErrorResponse_1.ErrorResponse(response.error);
            }
            else {
                // @ts-ignore
                let data = response.data || response.error.data || null;
                let errC;
                switch (response.error.code || -32603) {
                    case -32603:
                        errC = __1.InternalError;
                        break;
                    case -32602:
                        errC = __1.InvalidParams;
                        break;
                    case -32600:
                        errC = __1.InvalidRequest;
                        break;
                    case -32601:
                        errC = __1.MethodNotFound;
                        break;
                    case -32700:
                        errC = __1.ParseError;
                        break;
                    default:
                        errC = __1.ServerError;
                        break;
                }
                throw new errC(data, response.error.message || 'Internal error', response.error.code || -32603);
            }
        }
    }
    mapResponse(response, multiple) {
        if (response instanceof Array) {
            return response.map((item) => {
                return this.mapResponse(item, true);
            });
        }
        else {
            const errorHandle = this.errorHandler(response, multiple);
            if (errorHandle) {
                return errorHandle;
            }
            else {
                if (multiple) {
                    let result = new Response_1.Response();
                    result.code = response.code || undefined;
                    result.id = response.id || undefined;
                    result.jsonrpc = response.jsonrpc || undefined;
                    result.result = response.result || response;
                    return result;
                }
                else {
                    if (typeof response !== 'object' || !('result' in response)) {
                        throw new __1.ParseError(response);
                    }
                    return response.result;
                }
            }
        }
    }
    async request(url, params) {
        return this.axios
            .post(url, params, {})
            .then(response => (response ? response.data : response))
            .catch((err) => {
            if (err.response && err.response.data) {
                return this.mapResponse(err.response.data);
            }
            throw err;
        });
    }
    rpc(...args) {
        let data = args.flat(Infinity)
            .map((item, i) => {
            const data = {
                id: ++i,
                jsonrpc: '2.0',
                params: this.defaultParams,
                ...item,
            };
            data.params = this.reduceParams(data.params) || this.defaultParams;
            return data;
        });
        if (data.length === 1 && !(args[0] instanceof Array || args.length > 1)) {
            data = data[0];
        }
        return this
            .request('', data)
            .then(data => {
            return this.mapResponse(data);
        })
            .then((data) => data);
    }
    reduceParams(params) {
        for (const args of this.permanentArguments) {
            if (params instanceof Array) {
                params = params.concat(args);
            }
            else if (typeof params === 'object' && args.constructor.name === 'Object') {
                for (let k in args) {
                    // noinspection JSUnfilteredForInLoop
                    params[k] = args[k];
                }
            }
        }
        return params;
    }
    addPermanentArgument(params) {
        if (params instanceof Array) {
            this.permanentArguments = this.permanentArguments.concat(params);
        }
        else {
            this.permanentArguments.push(params);
        }
        return this;
    }
}
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvQ2xpZW50L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsa0RBQTBGO0FBQzFGLDJCQUFpRDtBQUNqRCxtREFBOEM7QUFDOUMsNkRBQXdEO0FBT2hELHdCQVBBLDZCQUFhLENBT0E7QUFOckIsMEJBQThHO0FBVTlHLE1BQWEsTUFBTTtJQUtmLFlBQVksTUFBcUI7UUFIakMsa0JBQWEsR0FBZSxFQUFFLENBQUM7UUFDL0IsdUJBQWtCLEdBQUcsRUFBRSxDQUFDO1FBR3BCLE1BQU0sR0FBRztZQUNMLE9BQU8sRUFBRTtnQkFDTCxjQUFjLEVBQUUsa0JBQWtCO2FBQ3JDO1lBQ0QsR0FBRyxNQUFNO1lBQ1QsR0FBRyxFQUFDLGdCQUFnQixFQUFoQixjQUFnQixFQUFDO1NBQ3hCLENBQUM7UUFFRixJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7WUFDaEIsSUFBSSxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3hDLElBQUksU0FBUyxDQUFDLFFBQVEsRUFBRTtnQkFDcEIsSUFBSSxXQUFXLEdBQUc7b0JBQ2QsUUFBUSxFQUFFLFNBQVMsQ0FBQyxRQUFRO29CQUM1QixRQUFRLEVBQUUsU0FBUyxDQUFDLFFBQVE7aUJBQy9CLENBQUM7Z0JBQ0YsT0FBTyxTQUFTLENBQUMsUUFBUSxDQUFDO2dCQUMxQixPQUFPLFNBQVMsQ0FBQyxRQUFRLENBQUM7Z0JBQzFCLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxXQUFXLENBQUM7Z0JBQzdCLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDO2FBQ3RDO1NBQ0o7UUFDRCxJQUFJLENBQUMsS0FBSyxHQUFHLGVBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVELFlBQVksQ0FBQyxRQUFhLEVBQUUsUUFB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SUFBSSxDQUFDLFdBQVcsQ0FBSSxJQUFXLENBQUMsQ0FBQztRQUM1QyxDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFTyxZQUFZLENBQUMsTUFBa0I7UUFDbkMsS0FBSyxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDeEMsSUFBSSxNQUFNLFlBQVksS0FBSyxFQUFFO2dCQUN6QixNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNoQztpQkFBTSxJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7Z0JBQ3pFLEtBQUssSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFO29CQUNoQixxQ0FBcUM7b0JBQ3JDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ3ZCO2FBQ0o7U0FDSjtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxvQkFBb0IsQ0FBQyxNQUFrQjtRQUNuQyxJQUFJLE1BQU0sWUFBWSxLQUFLLEVBQUU7WUFDekIsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDcEU7YUFBTTtZQUNILElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDeEM7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0NBQ0o7QUFoS0Qsd0JBZ0tDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEF4aW9zLCB7QXhpb3NFcnJvciwgQXhpb3NJbnN0YW5jZSwgQXhpb3NSZXF1ZXN0Q29uZmlnLCBBeGlvc1Jlc3BvbnNlfSBmcm9tIFwiYXhpb3NcIjtcbmltcG9ydCB7c3RyaW5naWZ5IGFzIHBhcmFtc1NlcmlhbGl6ZXJ9IGZyb20gJ3FzJztcbmltcG9ydCB7UmVzcG9uc2V9IGZyb20gXCIuL0Fic3RyYWN0cy9SZXNwb25zZVwiO1xuaW1wb3J0IHtFcnJvclJlc3BvbnNlfSBmcm9tIFwiLi9BYnN0cmFjdHMvRXJyb3JSZXNwb25zZVwiO1xuaW1wb3J0IHtJbnRlcm5hbEVycm9yLCBJbnZhbGlkUGFyYW1zLCBJbnZhbGlkUmVxdWVzdCwgTWV0aG9kTm90Rm91bmQsIFBhcnNlRXJyb3IsIFJQQywgU2VydmVyRXJyb3J9IGZyb20gXCIuLlwiO1xuXG5leHBvcnQgdHlwZSBDbGllbnRPcHRpb25zID0gQXhpb3NSZXF1ZXN0Q29uZmlnO1xuXG50eXBlIFRNYXBSZXNvdXJjZSA9IFJQQy5SZXNwb25zZS5JRGF0YTtcbnR5cGUgVE1hcFJldHVyblR5cGU8VD4gPSBSZXNwb25zZTxUPiB8IEVycm9yUmVzcG9uc2U7XG5leHBvcnQge0Vycm9yUmVzcG9uc2V9O1xuXG50eXBlIFRQYXJhbVR5cGUgPSBBcnJheTxhbnk+IHwge307XG5cbmV4cG9ydCBjbGFzcyBDbGllbnQge1xuICAgIGF4aW9zOiBBeGlvc0luc3RhbmNlO1xuICAgIGRlZmF1bHRQYXJhbXM6IFRQYXJhbVR5cGUgPSB7fTtcbiAgICBwZXJtYW5lbnRBcmd1bWVudHMgPSBbXTtcblxuICAgIGNvbnN0cnVjdG9yKGNvbmZpZzogQ2xpZW50T3B0aW9ucykge1xuICAgICAgICBjb25maWcgPSB7XG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC4uLmNvbmZpZyxcbiAgICAgICAgICAgIC4uLntwYXJhbXNTZXJpYWxpemVyfVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChjb25maWcuYmFzZVVSTCkge1xuICAgICAgICAgICAgbGV0IHBhcnNlZFVybCA9IG5ldyBVUkwoY29uZmlnLmJhc2VVUkwpO1xuICAgICAgICAgICAgaWYgKHBhcnNlZFVybC51c2VybmFtZSkge1xuICAgICAgICAgICAgICAgIGxldCBjcmVkZW50aWFscyA9IHtcbiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHBhcnNlZFVybC51c2VybmFtZSxcbiAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHBhcnNlZFVybC5wYXNzd29yZCxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBwYXJzZWRVcmwudXNlcm5hbWU7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHBhcnNlZFVybC5wYXNzd29yZDtcbiAgICAgICAgICAgICAgICBjb25maWdbJ2F1dGgnXSA9IGNyZWRlbnRpYWxzO1xuICAgICAgICAgICAgICAgIGNvbmZpZ1snYmFzZVVSTCddID0gcGFyc2VkVXJsLmhyZWY7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5heGlvcyA9IEF4aW9zLmNyZWF0ZShjb25maWcpO1xuICAgIH1cblxuICAgIGVycm9ySGFuZGxlcihyZXNwb25zZTogYW55LCBtdWx0aXBsZT86IGJvb2xlYW4pOiBFcnJvclJlc3BvbnNlIHwgdm9pZCB7XG4gICAgICAgIGlmICghIXJlc3BvbnNlLmVycm9yKSB7XG4gICAgICAgICAgICBpZiAobXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEVycm9yUmVzcG9uc2UocmVzcG9uc2UuZXJyb3IpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgbGV0IGRhdGEgPSByZXNwb25zZS5kYXRhIHx8IHJlc3BvbnNlLmVycm9yLmRhdGEgfHwgbnVsbDtcblxuICAgICAgICAgICAgICAgIGxldCBlcnJDO1xuXG4gICAgICAgICAgICAgICAgc3dpdGNoIChyZXNwb25zZS5lcnJvci5jb2RlIHx8IC0zMjYwMykge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIC0zMjYwMzpcbiAgICAgICAgICAgICAgICAgICAgICAgIGVyckMgPSBJbnRlcm5hbEVycm9yO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgLTMyNjAyOlxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyQyA9IEludmFsaWRQYXJhbXM7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAtMzI2MDA6XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJDID0gSW52YWxpZFJlcXVlc3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAtMzI2MDE6XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJDID0gTWV0aG9kTm90Rm91bmQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAtMzI3MDA6XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJDID0gUGFyc2VFcnJvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyQyA9IFNlcnZlckVycm9yO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IGVyckMoZGF0YSwgcmVzcG9uc2UuZXJyb3IubWVzc2FnZSB8fCAnSW50ZXJuYWwgZXJyb3InLCByZXNwb25zZS5lcnJvci5jb2RlIHx8IC0zMjYwMyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBtYXBSZXNwb25zZTxUPihyZXNwb25zZTogVE1hcFJlc291cmNlW10sIG11bHRpcGxlPzogYm9vbGVhbik6IFRNYXBSZXR1cm5UeXBlPFQ+W107XG4gICAgbWFwUmVzcG9uc2U8VD4ocmVzcG9uc2U6IFRNYXBSZXNvdXJjZSwgbXVsdGlwbGU/OiBib29sZWFuKTogVE1hcFJldHVyblR5cGU8VD47XG4gICAgbWFwUmVzcG9uc2U8VD4ocmVzcG9uc2U6IFRNYXBSZXNvdXJjZSB8IFRNYXBSZXNvdXJjZVtdLCBtdWx0aXBsZT86IGJvb2xlYW4pOiBUTWFwUmV0dXJuVHlwZTxUPiB8IFRNYXBSZXR1cm5UeXBlPFQ+W10ge1xuICAgICAgICBpZiAocmVzcG9uc2UgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLm1hcCgoaXRlbTogVE1hcFJlc291cmNlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwUmVzcG9uc2U8VD4oaXRlbSwgdHJ1ZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9ySGFuZGxlID0gdGhpcy5lcnJvckhhbmRsZXIocmVzcG9uc2UsIG11bHRpcGxlKTtcbiAgICAgICAgICAgIGlmIChlcnJvckhhbmRsZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBlcnJvckhhbmRsZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBuZXcgUmVzcG9uc2U8VD4oKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmNvZGUgPSByZXNwb25zZS5jb2RlIHx8IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmlkID0gcmVzcG9uc2UuaWQgfHwgdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQuanNvbnJwYyA9IHJlc3BvbnNlLmpzb25ycGMgfHwgdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzdWx0ID0gcmVzcG9uc2UucmVzdWx0IHx8IHJlc3BvbnNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVzcG9uc2UgIT09ICdvYmplY3QnIHx8ICEoJ3Jlc3VsdCcgaW4gcmVzcG9uc2UpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUGFyc2VFcnJvcihyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlc3VsdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyByZXF1ZXN0KHVybCwgcGFyYW1zKTogUHJvbWlzZTxBeGlvc1Jlc3BvbnNlIHwgQXhpb3NSZXNwb25zZVtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmF4aW9zXG4gICAgICAgICAgICAucG9zdCh1cmwsIHBhcmFtcywge30pXG4gICAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiAocmVzcG9uc2UgPyByZXNwb25zZS5kYXRhIDogcmVzcG9uc2UpKVxuICAgICAgICAgICAgLmNhdGNoKChlcnI6IEF4aW9zRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyLnJlc3BvbnNlICYmIGVyci5yZXNwb25zZS5kYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcFJlc3BvbnNlKGVyci5yZXNwb25zZS5kYXRhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcnBjPFQ+KGFyZ3M6IFJQQy5JUGF5bG9hZCk6IFByb21pc2U8VD47XG4gICAgcnBjPFQ+KGFyZzE6IFJQQy5JUGF5bG9hZCwgLi4uYXJnczogUlBDLklQYXlsb2FkW10pOiBQcm9taXNlPFRNYXBSZXR1cm5UeXBlPFQ+W10+O1xuICAgIHJwYzxUPihhcmdzOiBSUEMuSVBheWxvYWRbXSk6IFByb21pc2U8VE1hcFJldHVyblR5cGU8VD5bXT47XG4gICAgcnBjPFQ+KC4uLmFyZ3M6IChSUEMuSVBheWxvYWQgfCBSUEMuSVBheWxvYWRbXSlbXSk6IFByb21pc2U8VD4ge1xuICAgICAgICBsZXQgZGF0YTogKFJQQy5JUGF5bG9hZCB8IFJQQy5JUGF5bG9hZFtdKSA9IGFyZ3MuZmxhdChJbmZpbml0eSlcbiAgICAgICAgICAgIC5tYXAoKGl0ZW0sIGkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0ge1xuICAgICAgICAgICAgICAgICAgICBpZDogKytpLFxuICAgICAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zOiB0aGlzLmRlZmF1bHRQYXJhbXMsXG4gICAgICAgICAgICAgICAgICAgIC4uLml0ZW0sXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGRhdGEucGFyYW1zID0gdGhpcy5yZWR1Y2VQYXJhbXMoZGF0YS5wYXJhbXMpIHx8IHRoaXMuZGVmYXVsdFBhcmFtcztcblxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICAgICAgfSk7XG5cblxuICAgICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDEgJiYgIShhcmdzWzBdIGluc3RhbmNlb2YgQXJyYXkgfHwgYXJncy5sZW5ndGggPiAxKSkge1xuICAgICAgICAgICAgZGF0YSA9IGRhdGFbMF07XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpc1xuICAgICAgICAgICAgLnJlcXVlc3QoJycsIGRhdGEpXG4gICAgICAgICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tYXBSZXNwb25zZTxUPihkYXRhIGFzIGFueSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKGRhdGE6IGFueSkgPT4gZGF0YSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWR1Y2VQYXJhbXMocGFyYW1zOiBUUGFyYW1UeXBlKTogVFBhcmFtVHlwZSB7XG4gICAgICAgIGZvciAoY29uc3QgYXJncyBvZiB0aGlzLnBlcm1hbmVudEFyZ3VtZW50cykge1xuICAgICAgICAgICAgaWYgKHBhcmFtcyBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zLmNvbmNhdChhcmdzKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ29iamVjdCcgJiYgYXJncy5jb25zdHJ1Y3Rvci5uYW1lID09PSAnT2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGsgaW4gYXJncykge1xuICAgICAgICAgICAgICAgICAgICAvLyBub2luc3BlY3Rpb24gSlNVbmZpbHRlcmVkRm9ySW5Mb29wXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtc1trXSA9IGFyZ3Nba107XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwYXJhbXM7XG4gICAgfVxuXG4gICAgYWRkUGVybWFuZW50QXJndW1lbnQocGFyYW1zOiBUUGFyYW1UeXBlKTogdGhpcyB7XG4gICAgICAgIGlmIChwYXJhbXMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgdGhpcy5wZXJtYW5lbnRBcmd1bWVudHMgPSB0aGlzLnBlcm1hbmVudEFyZ3VtZW50cy5jb25jYXQocGFyYW1zKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucGVybWFuZW50QXJndW1lbnRzLnB1c2gocGFyYW1zKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG59XG4iXX0=