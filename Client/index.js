"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const axios_1 = __importDefault(require("axios"));
const qs_1 = require("qs");
const Response_1 = require("./Abstracts/Response");
const ErrorResponse_1 = require("./Abstracts/ErrorResponse");
exports.ErrorResponse = ErrorResponse_1.ErrorResponse;
const __1 = require("..");
class Client {
    constructor(config) {
        config = {
            headers: {
                'Content-Type': 'application/json'
            },
            ...config,
            ...{ paramsSerializer: qs_1.stringify }
        };
        if (config.baseURL) {
            let parsedUrl = new URL(config.baseURL);
            if (parsedUrl.username) {
                let credentials = {
                    username: parsedUrl.username,
                    password: parsedUrl.password,
                };
                delete parsedUrl.username;
                delete parsedUrl.password;
                config['auth'] = credentials;
                config['baseURL'] = parsedUrl.href;
            }
        }
        this.axios = axios_1.default.create(config);
    }
    mapResponse(response, multiple) {
        if (response instanceof Array) {
            return response.map((item) => {
                return this.mapResponse(item, true);
            });
        }
        else {
            if (!!response.error) {
                if (multiple) {
                    throw new ErrorResponse_1.ErrorResponse(response.error);
                }
                else {
                    // @ts-ignore
                    let data = response.data || response.error.data || null;
                    let errC;
                    switch (response.error.code || -32603) {
                        case -32603:
                            errC = __1.InternalError;
                            break;
                        case -32602:
                            errC = __1.InvalidParams;
                            break;
                        case -32600:
                            errC = __1.InvalidRequest;
                            break;
                        case -32601:
                            errC = __1.MethodNotFound;
                            break;
                        case -32700:
                            errC = __1.ParseError;
                            break;
                        default:
                            errC = __1.ServerError;
                            break;
                    }
                    throw new errC(data, response.error.message || 'Internal error', response.error.code || -32603);
                }
            }
            else {
                if (multiple) {
                    let result = new Response_1.Response();
                    result.code = response.code || undefined;
                    result.id = response.id || undefined;
                    result.jsonrpc = response.jsonrpc || undefined;
                    result.result = response.result || response;
                    return result;
                }
                else {
                    if (typeof response !== 'object' || !('result' in response)) {
                        throw new __1.ParseError(response);
                    }
                    return response.result;
                }
            }
        }
    }
    async request(url, params) {
        return this.axios
            .post(url, params || this.defaultParams, {})
            .then(response => (response ? response.data : response))
            .catch((err) => {
            if (err.response && err.response.data) {
                return this.mapResponse(err.response.data);
            }
            throw err;
        });
    }
    rpc(...args) {
        let data = args.flat(Infinity)
            .map((item, i) => {
            return {
                id: ++i,
                jsonrpc: '2.0',
                params: {},
                ...item,
            };
        });
        if (data.length === 1 && !(args[0] instanceof Array || args.length > 1)) {
            data = data[0];
        }
        return this
            .request('', data)
            .then(data => {
            return this.mapResponse(data);
        })
            .then((data) => data);
    }
}
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvQ2xpZW50L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsa0RBQTBGO0FBQzFGLDJCQUFpRDtBQUNqRCxtREFBOEM7QUFDOUMsNkRBQXdEO0FBT2hELHdCQVBBLDZCQUFhLENBT0E7QUFOckIsMEJBQThHO0FBUTlHLE1BQWEsTUFBTTtJQUlmLFlBQVksTUFBcUI7UUFDN0IsTUFBTSxHQUFHO1lBQ0wsT0FBTyxFQUFFO2dCQUNMLGNBQWMsRUFBRSxrQkFBa0I7YUFDckM7WUFDRCxHQUFHLE1BQU07WUFDVCxHQUFHLEVBQUMsZ0JBQWdCLEVBQWhCLGNBQWdCLEVBQUM7U0FDeEIsQ0FBQztRQUVGLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtZQUNoQixJQUFJLFNBQVMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDeEMsSUFBSSxTQUFTLENBQUMsUUFBUSxFQUFFO2dCQUNwQixJQUFJLFdBQVcsR0FBRztvQkFDZCxRQUFRLEVBQUUsU0FBUyxDQUFDLFFBQVE7b0JBQzVCLFFBQVEsRUFBRSxTQUFTLENBQUMsUUFBUTtpQkFDL0IsQ0FBQztnQkFDRixPQUFPLFNBQVMsQ0FBQyxRQUFRLENBQUM7Z0JBQzFCLE9BQU8sU0FBUyxDQUFDLFFBQVEsQ0FBQztnQkFDMUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLFdBQVcsQ0FBQztnQkFDN0IsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7YUFDdEM7U0FDSjtRQUNELElBQUksQ0FBQyxLQUFLLEdBQUcsZUFBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBSUQsV0FBVyxDQUFJLFFBQXVDLEVBQUUsUUFBa0I7UUFDdEUsSUFBSSxRQUFRLFlBQVksS0FBSyxFQUFFO1lBQzNCLE9BQU8sUUFBUSxDQUFD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QUMsSUFBSSxDQUFDLENBQUM7YUFDOUM7WUFDRCxNQUFNLEdBQUcsQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUtELEdBQUcsQ0FBSSxHQUFHLElBQXVDO1FBQzdDLElBQUksSUFBSSxHQUFvQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQzthQUMxRCxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDYixPQUFPO2dCQUNILEVBQUUsRUFBRSxFQUFFLENBQUM7Z0JBQ1AsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsTUFBTSxFQUFFLEVBQUU7Z0JBQ1YsR0FBRyxJQUFJO2FBQ1YsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUFDO1FBRVAsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxZQUFZLEtBQUssSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFO1lBQ3JFLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbEI7UUFFRCxPQUFPLElBQUk7YUFDTixPQUFPLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQzthQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDVCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUksSUFBVyxDQUFDLENBQUM7UUFDNUMsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLENBQUMsSUFBUyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuQyxDQUFDO0NBQ0o7QUE1SEQsd0JBNEhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEF4aW9zLCB7QXhpb3NFcnJvciwgQXhpb3NJbnN0YW5jZSwgQXhpb3NSZXF1ZXN0Q29uZmlnLCBBeGlvc1Jlc3BvbnNlfSBmcm9tIFwiYXhpb3NcIjtcbmltcG9ydCB7c3RyaW5naWZ5IGFzIHBhcmFtc1NlcmlhbGl6ZXJ9IGZyb20gJ3FzJztcbmltcG9ydCB7UmVzcG9uc2V9IGZyb20gXCIuL0Fic3RyYWN0cy9SZXNwb25zZVwiO1xuaW1wb3J0IHtFcnJvclJlc3BvbnNlfSBmcm9tIFwiLi9BYnN0cmFjdHMvRXJyb3JSZXNwb25zZVwiO1xuaW1wb3J0IHtJbnRlcm5hbEVycm9yLCBJbnZhbGlkUGFyYW1zLCBJbnZhbGlkUmVxdWVzdCwgTWV0aG9kTm90Rm91bmQsIFBhcnNlRXJyb3IsIFJQQywgU2VydmVyRXJyb3J9IGZyb20gXCIuLlwiO1xuXG5leHBvcnQgdHlwZSBDbGllbnRPcHRpb25zID0gQXhpb3NSZXF1ZXN0Q29uZmlnO1xuXG50eXBlIFRNYXBSZXNvdXJjZSA9IFJQQy5SZXNwb25zZS5JRGF0YTtcbnR5cGUgVE1hcFJldHVyblR5cGU8VD4gPSBSZXNwb25zZTxUPiB8IEVycm9yUmVzcG9uc2U7XG5leHBvcnQge0Vycm9yUmVzcG9uc2V9O1xuXG5leHBvcnQgY2xhc3MgQ2xpZW50IHtcbiAgICBheGlvczogQXhpb3NJbnN0YW5jZTtcbiAgICBkZWZhdWx0UGFyYW1zOiBbXTtcblxuICAgIGNvbnN0cnVjdG9yKGNvbmZpZzogQ2xpZW50T3B0aW9ucykge1xuICAgICAgICBjb25maWcgPSB7XG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC4uLmNvbmZpZyxcbiAgICAgICAgICAgIC4uLntwYXJhbXNTZXJpYWxpemVyfVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChjb25maWcuYmFzZVVSTCkge1xuICAgICAgICAgICAgbGV0IHBhcnNlZFVybCA9IG5ldyBVUkwoY29uZmlnLmJhc2VVUkwpO1xuICAgICAgICAgICAgaWYgKHBhcnNlZFVybC51c2VybmFtZSkge1xuICAgICAgICAgICAgICAgIGxldCBjcmVkZW50aWFscyA9IHtcbiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHBhcnNlZFVybC51c2VybmFtZSxcbiAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHBhcnNlZFVybC5wYXNzd29yZCxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBwYXJzZWRVcmwudXNlcm5hbWU7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHBhcnNlZFVybC5wYXNzd29yZDtcbiAgICAgICAgICAgICAgICBjb25maWdbJ2F1dGgnXSA9IGNyZWRlbnRpYWxzO1xuICAgICAgICAgICAgICAgIGNvbmZpZ1snYmFzZVVSTCddID0gcGFyc2VkVXJsLmhyZWY7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5heGlvcyA9IEF4aW9zLmNyZWF0ZShjb25maWcpO1xuICAgIH1cblxuICAgIG1hcFJlc3BvbnNlPFQ+KHJlc3BvbnNlOiBUTWFwUmVzb3VyY2VbXSwgbXVsdGlwbGU/OiBib29sZWFuKTogVE1hcFJldHVyblR5cGU8VD5bXTtcbiAgICBtYXBSZXNwb25zZTxUPihyZXNwb25zZTogVE1hcFJlc291cmNlLCBtdWx0aXBsZT86IGJvb2xlYW4pOiBUTWFwUmV0dXJuVHlwZTxUPjtcbiAgICBtYXBSZXNwb25zZTxUPihyZXNwb25zZTogVE1hcFJlc291cmNlIHwgVE1hcFJlc291cmNlW10sIG11bHRpcGxlPzogYm9vbGVhbik6IFRNYXBSZXR1cm5UeXBlPFQ+IHwgVE1hcFJldHVyblR5cGU8VD5bXSB7XG4gICAgICAgIGlmIChyZXNwb25zZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UubWFwKChpdGVtOiBUTWFwUmVzb3VyY2UpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tYXBSZXNwb25zZTxUPihpdGVtLCB0cnVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCEhcmVzcG9uc2UuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yUmVzcG9uc2UocmVzcG9uc2UuZXJyb3IpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGEgPSByZXNwb25zZS5kYXRhIHx8IHJlc3BvbnNlLmVycm9yLmRhdGEgfHwgbnVsbDtcblxuICAgICAgICAgICAgICAgICAgICBsZXQgZXJyQztcblxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHJlc3BvbnNlLmVycm9yLmNvZGUgfHwgLTMyNjAzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIC0zMjYwMzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJDID0gSW50ZXJuYWxFcnJvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgLTMyNjAyOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVyckMgPSBJbnZhbGlkUGFyYW1zO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAtMzI2MDA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyQyA9IEludmFsaWRSZXF1ZXN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAtMzI2MDE6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyQyA9IE1ldGhvZE5vdEZvdW5kO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAtMzI3MDA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyQyA9IFBhcnNlRXJyb3I7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVyckMgPSBTZXJ2ZXJFcnJvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBlcnJDKGRhdGEsIHJlc3BvbnNlLmVycm9yLm1lc3NhZ2UgfHwgJ0ludGVybmFsIGVycm9yJywgcmVzcG9uc2UuZXJyb3IuY29kZSB8fCAtMzI2MDMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBuZXcgUmVzcG9uc2U8VD4oKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmNvZGUgPSByZXNwb25zZS5jb2RlIHx8IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmlkID0gcmVzcG9uc2UuaWQgfHwgdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQuanNvbnJwYyA9IHJlc3BvbnNlLmpzb25ycGMgfHwgdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQucmVzdWx0ID0gcmVzcG9uc2UucmVzdWx0IHx8IHJlc3BvbnNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVzcG9uc2UgIT09ICdvYmplY3QnIHx8ICEoJ3Jlc3VsdCcgaW4gcmVzcG9uc2UpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUGFyc2VFcnJvcihyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlc3VsdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyByZXF1ZXN0KHVybCwgcGFyYW1zKTogUHJvbWlzZTxBeGlvc1Jlc3BvbnNlIHwgQXhpb3NSZXNwb25zZVtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmF4aW9zXG4gICAgICAgICAgICAucG9zdCh1cmwsIHBhcmFtcyB8fCB0aGlzLmRlZmF1bHRQYXJhbXMsIHt9KVxuICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gKHJlc3BvbnNlID8gcmVzcG9uc2UuZGF0YSA6IHJlc3BvbnNlKSlcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyOiBBeGlvc0Vycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVyci5yZXNwb25zZSAmJiBlcnIucmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tYXBSZXNwb25zZShlcnIucmVzcG9uc2UuZGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJwYzxUPihhcmdzOiBSUEMuSVBheWxvYWQpOiBQcm9taXNlPFQ+O1xuICAgIHJwYzxUPihhcmcxOiBSUEMuSVBheWxvYWQsIC4uLmFyZ3M6IFJQQy5JUGF5bG9hZFtdKTogUHJvbWlzZTxUTWFwUmV0dXJuVHlwZTxUPltdPjtcbiAgICBycGM8VD4oYXJnczogUlBDLklQYXlsb2FkW10pOiBQcm9taXNlPFRNYXBSZXR1cm5UeXBlPFQ+W10+O1xuICAgIHJwYzxUPiguLi5hcmdzOiAoUlBDLklQYXlsb2FkIHwgUlBDLklQYXlsb2FkW10pW10pOiBQcm9taXNlPFQ+IHtcbiAgICAgICAgbGV0IGRhdGE6IChSUEMuSVBheWxvYWQgfCBSUEMuSVBheWxvYWRbXSkgPSBhcmdzLmZsYXQoSW5maW5pdHkpXG4gICAgICAgICAgICAubWFwKChpdGVtLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6ICsraSxcbiAgICAgICAgICAgICAgICAgICAganNvbnJwYzogJzIuMCcsXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtczoge30sXG4gICAgICAgICAgICAgICAgICAgIC4uLml0ZW0sXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMSAmJiAhKGFyZ3NbMF0gaW5zdGFuY2VvZiBBcnJheSB8fCBhcmdzLmxlbmd0aCA+IDEpKSB7XG4gICAgICAgICAgICBkYXRhID0gZGF0YVswXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzXG4gICAgICAgICAgICAucmVxdWVzdCgnJywgZGF0YSlcbiAgICAgICAgICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcFJlc3BvbnNlPFQ+KGRhdGEgYXMgYW55KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoZGF0YTogYW55KSA9PiBkYXRhKTtcbiAgICB9XG59XG4iXX0=