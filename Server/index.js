"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const Routes_1 = require("./Library/Routes");
const __1 = require("..");
const events_1 = require("events");
const __2 = require("..");
const Output_1 = require("./Library/Output");
exports.Output = Output_1.Output;
const bodyParser = require("body-parser");
class Server extends events_1.EventEmitter {
    //endregion
    constructor() {
        super();
        this.handle = express_1.default();
        this.routes = new Routes_1.Routes();
    }
    on(event, listener) {
        super.on(event, listener);
        return this;
    }
    emit(event, ...args) {
        return super.emit(event, ...args);
    }
    init() {
        let app = this.handle;
        app.set('trust proxy', true);
        //region Middlewares
        //For request emitter
        app.use(bodyParser.urlencoded({ extended: false }));
        app.use(bodyParser.json());
        // Error catch for bodyParser
        app.use((err, req, res, next) => {
            if (err instanceof SyntaxError) {
                next(new __1.ParseError());
            }
            else {
                next(err, req, res);
            }
        });
        //Parsing body
        app.use((req, res, next) => {
            if (!req.body) {
                return next(new __2.InvalidParams({
                    message: 'Request body not found.'
                }));
            }
            if ('object' !== typeof req.body || !('string' === typeof req.body.method && req.body.id && req.body.id)) {
                return next(new __2.InvalidParams({
                    message: 'Invalid JSON-RPC Request Body'
                }));
            }
            next();
        });
        //endregion
        app.use((req, res, next) => {
            this.emit('request', req.body, req, res);
            next();
        });
        app.use((err, req, res, next) => {
            let output = Output_1.Output.generate(err, req.body || {}, res);
            res
                .send(output)
                .end();
            this.emit('error', err, req.body, req, res);
        });
        app.post('/?$', (req, res) => {
            this.emit('routing', req);
            Promise
                .resolve(null)
                .then(() => {
                let body = req.body;
                return this.routes.call(body.method, body.params, req, res);
            })
                .then((result) => {
                //On success
                let output = Output_1.Output.generate(result, req.body || {}, res);
                this.emit('response', output);
                res
                    .send(output)
                    .end();
            }, (e) => {
                //On error
                let output = Output_1.Output.generate(e, req.body || {}, res);
                res
                    .send(output)
                    .end();
                this.emit('error', e, req.body, req, res);
            });
        });
        app.get('/?$', () => {
            throw new __1.ParseError();
        });
    }
    listen(port, host) {
        return new Promise((succ, err) => {
            return this.listener = this.handle.listen(port, host, () => {
                this.emit('ready', this.listener.address());
                succ(this.listener);
            }).on('error', err);
        });
    }
    close() {
        return new Promise((resolve, reject) => {
            this.listener.close(err => {
                if (!!err) {
                    reject(err);
                }
                else {
                    resolve();
                }
            });
        });
    }
}
exports.Server = Server;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvU2VydmVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsc0RBQTREO0FBQzVELDZDQUF3QztBQUN4QywwQkFBOEI7QUFDOUIsbUNBQW9DO0FBRXBDLDBCQUFzQztBQUN0Qyw2Q0FBd0M7QUFJaEMsaUJBSkEsZUFBTSxDQUlBO0FBRmQsMENBQTJDO0FBSTNDLE1BQWEsTUFBTyxTQUFRLHFCQUFZO0lBOERwQyxXQUFXO0lBRVg7UUFDSSxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxNQUFNLEdBQUcsaUJBQU8sRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxlQUFNLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBdkNELEVBQUUsQ0FBQyxLQUFhLEVBQUUsUUFBMkI7UUFDekMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDMUIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQTBCRCxJQUFJLENBQUMsS0FBYSxFQUFFLEdBQUcsSUFBSTtRQUN2QixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQVVELElBQUk7UUFDQSxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ3RCLEdBQUcsQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTdCLG9CQUFvQjtRQUVwQixxQkFBcUI7UUFDckIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUMsUUFBUSxFQUFFLEtBQUssRUFBQyxDQUFDLENBQUMsQ0FBQztRQUNsRCxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRTNCLDZCQUE2QjtRQUM3QixH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TyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNuQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDdEIsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFO29CQUNQLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDZjtxQkFBTTtvQkFDSCxPQUFPLEVBQUUsQ0FBQztpQkFDYjtZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUF0S0Qsd0JBc0tDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MsIHtFeHByZXNzLCBSZXF1ZXN0LCBSZXNwb25zZX0gZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCB7Um91dGVzfSBmcm9tIFwiLi9MaWJyYXJ5L1JvdXRlc1wiO1xuaW1wb3J0IHtQYXJzZUVycm9yfSBmcm9tIFwiLi5cIjtcbmltcG9ydCB7RXZlbnRFbWl0dGVyfSBmcm9tIFwiZXZlbnRzXCI7XG5pbXBvcnQgKiBhcyBodHRwIGZyb20gXCJodHRwXCI7XG5pbXBvcnQge0ludmFsaWRQYXJhbXMsIFJQQ30gZnJvbSBcIi4uXCI7XG5pbXBvcnQge091dHB1dH0gZnJvbSBcIi4vTGlicmFyeS9PdXRwdXRcIjtcbmltcG9ydCB7QWRkcmVzc0luZm99IGZyb20gXCJuZXRcIjtcbmltcG9ydCBib2R5UGFyc2VyID0gcmVxdWlyZShcImJvZHktcGFyc2VyXCIpO1xuXG5leHBvcnQge091dHB1dH07XG5cbmV4cG9ydCBjbGFzcyBTZXJ2ZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGhhbmRsZTogRXhwcmVzcztcbiAgICBsaXN0ZW5lcjogaHR0cC5TZXJ2ZXI7XG4gICAgcm91dGVzOiBSb3V0ZXM7XG5cbiAgICAvL3JlZ2lvbiBPblxuXG4gICAgb24oZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAocG9ydDogbnVtYmVyLCBob3N0bmFtZTogc3RyaW5nLCBiYWNrbG9nOiBudW1iZXIsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBvcnQ6IG51bWJlciwgaG9zdG5hbWU6IHN0cmluZywgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZXNwb25zZScsIGNhbGxiYWNrOiAob3V0cHV0OiBSUEMuUmVzcG9uc2UuSURhdGEsIHJlcT86IFJlcXVlc3QsIHJlcz86IFJlc3BvbnNlKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVxdWVzdCcsIGNhbGxiYWNrOiAoYm9keTogUlBDLlJlcXVlc3QuSURhdGEsIHJlcT86IFJlcXVlc3QsIHJlcz86IFJlc3BvbnNlKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBvcnQ6IG51bWJlciwgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAocGF0aDogc3RyaW5nLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChoYW5kbGU6IGFueSwgbGlzdGVuaW5nTGlzdGVuZXI/OiAoKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKGFkZHJlc3M6IEFkZHJlc3NJbmZvIHwgc3RyaW5nIHwgbnVsbCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JvdXRpbmcnLCBjYWxsYmFjazogKHJlcTogUmVxdWVzdCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ2Vycm9yJywgY2FsbGJhY2s6IChlOiBFcnJvciwgYm9keT86IGFueSwgcmVxPzogUmVxdWVzdCwgcmVzPzogUmVzcG9uc2UpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6IHN0cmluZywgbGlzdGVuZXI6ICguLi5hcmdzKSA9PiB2b2lkKTogdGhpcyB7XG4gICAgICAgIHN1cGVyLm9uKGV2ZW50LCBsaXN0ZW5lcik7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8vZW5kcmVnaW9uXG5cbiAgICAvL3JlZ2lvbiBFbWl0c1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgcG9ydDogbnVtYmVyLCBob3N0bmFtZTogc3RyaW5nLCBiYWNrbG9nOiBudW1iZXIsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyZWFkeScsIHBvcnQ6IG51bWJlciwgaG9zdG5hbWU6IHN0cmluZywgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3Jlc3BvbnNlJywgb3V0cHV0OiBSUEMuUmVzcG9uc2UuSURhdGEsIHJlcT86IFJlcXVlc3QsIHJlcz86IFJlc3BvbnNlKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdlcnJvcicsIGU6IEVycm9yLCBib2R5PzogYW55LCByZXE/OiBSZXF1ZXN0LCByZXM/OiBSZXNwb25zZSk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncmVhZHknLCBwb3J0OiBudW1iZXIsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyZWFkeScsIHBhdGg6IHN0cmluZywgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgaGFuZGxlOiBhbnksIGxpc3RlbmluZ0xpc3RlbmVyPzogKCkgPT4gdm9pZCk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncmVxdWVzdCcsIGJvZHk6IGFueSwgcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyb3V0aW5nJywgcmVxOiBSZXF1ZXN0KTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6IHN0cmluZywgLi4uYXJncyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gc3VwZXIuZW1pdChldmVudCwgLi4uYXJncyk7XG4gICAgfVxuXG4gICAgLy9lbmRyZWdpb25cblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLmhhbmRsZSA9IGV4cHJlc3MoKTtcbiAgICAgICAgdGhpcy5yb3V0ZXMgPSBuZXcgUm91dGVzKCk7XG4gICAgfVxuXG4gICAgaW5pdCgpIHtcbiAgICAgICAgbGV0IGFwcCA9IHRoaXMuaGFuZGxlO1xuICAgICAgICBhcHAuc2V0KCd0cnVzdCBwcm94eScsIHRydWUpO1xuXG4gICAgICAgIC8vcmVnaW9uIE1pZGRsZXdhcmVzXG5cbiAgICAgICAgLy9Gb3IgcmVxdWVzdCBlbWl0dGVyXG4gICAgICAgIGFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHtleHRlbmRlZDogZmFsc2V9KSk7XG4gICAgICAgIGFwcC51c2UoYm9keVBhcnNlci5qc29uKCkpO1xuXG4gICAgICAgIC8vIEVycm9yIGNhdGNoIGZvciBib2R5UGFyc2VyXG4gICAgICAgIGFwcC51c2UoKGVyciwgcmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikge1xuICAgICAgICAgICAgICAgIG5leHQobmV3IFBhcnNlRXJyb3IoKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5leHQoZXJyLCByZXEsIHJlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vUGFyc2luZyBib2R5XG4gICAgICAgIGFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgICAgICBpZiAoIXJlcS5ib2R5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5leHQobmV3IEludmFsaWRQYXJhbXMoe1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnUmVxdWVzdCBib2R5IG5vdCBmb3VuZC4nXG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCdvYmplY3QnICE9PSB0eXBlb2YgcmVxLmJvZHkgfHwgISgnc3RyaW5nJyA9PT0gdHlwZW9mIHJlcS5ib2R5Lm1ldGhvZCAmJiByZXEuYm9keS5pZCAmJiByZXEuYm9keS5pZCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dChuZXcgSW52YWxpZFBhcmFtcyh7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIEpTT04tUlBDIFJlcXVlc3QgQm9keSdcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgIH0pO1xuICAgICAgICAvL2VuZHJlZ2lvblxuXG4gICAgICAgIGFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3JlcXVlc3QnLCByZXEuYm9keSwgcmVxLCByZXMpO1xuICAgICAgICAgICAgbmV4dCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgYXBwLnVzZSgoZXJyLCByZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgICAgbGV0IG91dHB1dCA9IE91dHB1dC5nZW5lcmF0ZShlcnIsIHJlcS5ib2R5IHx8IHt9LCByZXMpO1xuICAgICAgICAgICAgcmVzXG4gICAgICAgICAgICAgICAgLnNlbmQob3V0cHV0KVxuICAgICAgICAgICAgICAgIC5lbmQoKTtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlcnIsIHJlcS5ib2R5LCByZXEsIHJlcyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGFwcC5wb3N0KCcvPyQnLCAocmVxLCByZXMpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgncm91dGluZycsIHJlcSk7XG4gICAgICAgICAgICBQcm9taXNlXG4gICAgICAgICAgICAgICAgLnJlc29sdmUobnVsbClcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBib2R5OiBSUEMuUmVxdWVzdC5JRGF0YSA9IHJlcS5ib2R5O1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yb3V0ZXMuY2FsbChib2R5Lm1ldGhvZCwgYm9keS5wYXJhbXMsIHJlcSwgcmVzKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy9PbiBzdWNjZXNzXG4gICAgICAgICAgICAgICAgICAgIGxldCBvdXRwdXQgPSBPdXRwdXQuZ2VuZXJhdGUocmVzdWx0LCByZXEuYm9keSB8fCB7fSwgcmVzKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdyZXNwb25zZScsIG91dHB1dCk7XG4gICAgICAgICAgICAgICAgICAgIHJlc1xuICAgICAgICAgICAgICAgICAgICAgICAgLnNlbmQob3V0cHV0KVxuICAgICAgICAgICAgICAgICAgICAgICAgLmVuZCgpO1xuICAgICAgICAgICAgICAgIH0sIChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vT24gZXJyb3JcbiAgICAgICAgICAgICAgICAgICAgbGV0IG91dHB1dCA9IE91dHB1dC5nZW5lcmF0ZShlLCByZXEuYm9keSB8fCB7fSwgcmVzKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzXG4gICAgICAgICAgICAgICAgICAgICAgICAuc2VuZChvdXRwdXQpXG4gICAgICAgICAgICAgICAgICAgICAgICAuZW5kKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlLCByZXEuYm9keSwgcmVxLCByZXMpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgYXBwLmdldCgnLz8kJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFBhcnNlRXJyb3IoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgbGlzdGVuKHBvcnQ6IG51bWJlciwgaG9zdD86IHN0cmluZyk6IFByb21pc2U8aHR0cC5TZXJ2ZXI+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChzdWNjLCBlcnIpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmxpc3RlbmVyID0gdGhpcy5oYW5kbGUubGlzdGVuKHBvcnQsIGhvc3QsICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ3JlYWR5JywgdGhpcy5saXN0ZW5lci5hZGRyZXNzKCkpO1xuICAgICAgICAgICAgICAgIHN1Y2ModGhpcy5saXN0ZW5lcik7XG4gICAgICAgICAgICB9KS5vbignZXJyb3InLCBlcnIpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjbG9zZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXIuY2xvc2UoZXJyID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoISFlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=