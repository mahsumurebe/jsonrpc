"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const Routes_1 = require("./Library/Routes");
const __1 = require("..");
const events_1 = require("events");
const Output_1 = require("./Library/Output");
exports.Output = Output_1.Output;
const bodyParser = require("body-parser");
class Server extends events_1.EventEmitter {
    //endregion
    constructor() {
        super();
        this.handle = express_1.default();
        this.routes = new Routes_1.Routes();
    }
    on(event, listener) {
        super.on(event, listener);
        return this;
    }
    emit(event, ...args) {
        return super.emit(event, ...args);
    }
    init() {
        let app = this.handle;
        app.set('trust proxy', true);
        //region Middlewares
        //For request emitter
        app.use(bodyParser.urlencoded({ extended: false }));
        app.use(bodyParser.json());
        // Error catch for bodyParser
        app.use((err, req, res, next) => {
            if (err instanceof SyntaxError) {
                next(new __1.ParseError());
            }
            else {
                next(err, req, res);
            }
        });
        //Parsing body
        app.use((req, res, next) => {
            if (!req.body) {
                return next(new __1.InvalidParams({
                    message: 'Request body not found.'
                }));
            }
            const checkParams = (req) => {
                return 'object' !== typeof req.body || !('string' === typeof req.body.method && req.body.id && req.body.id);
            };
            const throwIt = () => {
                return next(new __1.InvalidParams({
                    message: 'Invalid JSON-RPC Request Body'
                }));
            };
            if (req.body instanceof Array) {
                for (const item of req.body) {
                    if (!checkParams(item)) {
                        return throwIt();
                    }
                }
            }
            else {
                if (!checkParams(req.body)) {
                    return throwIt();
                }
            }
            next();
        });
        //endregion
        app.use((req, res, next) => {
            this.emit('request', req.body, req, res);
            next();
        });
        app.use((err, req, res, next) => {
            let output = Output_1.Output.generate(err, req.body || {});
            res
                .send(output)
                .end();
            this.emit('error', err, req.body, req, res);
        });
        app.post('/?$', (req, res) => {
            this.emit('routing', req);
            let body = req.body;
            if (body instanceof Array) {
                return Promise.all(body
                    .map(bodyItem => this
                    .routes
                    .call(bodyItem.method, bodyItem.params, req, res)
                    .then(data => {
                    return Output_1.Output.generate(data, bodyItem);
                })
                    .catch(e => {
                    return Output_1.Output.generate(e, bodyItem);
                })))
                    .then(data => {
                    this.emit('response', data, req, res);
                    res.send(data)
                        .end();
                });
            }
            return this
                .routes
                .call(body.method, body.params, req, res)
                .then(data => {
                //On success
                let output = Output_1.Output.generate(data, req.body);
                this.emit('response', output, req, res);
                res.send(output)
                    .end();
            })
                .catch(e => {
                //On error
                let output = Output_1.Output.generate(e, req.body);
                res.send(output)
                    .end();
                this.emit('error', e, req.body, req, res);
            });
        });
        app.get('/?$', () => {
            throw new __1.ParseError(undefined, 'JSONRPC server handles only POST requests');
        });
    }
    listen(port, host) {
        return new Promise((succ, err) => {
            return this.listener = this.handle.listen(port, host, () => {
                this.emit('ready', this.listener.address());
                succ(this.listener);
            }).on('error', err);
        });
    }
    close() {
        return new Promise((resolve, reject) => {
            this.listener.close(err => {
                if (!!err) {
                    reject(err);
                }
                else {
                    resolve();
                }
            });
        });
    }
}
exports.Server = Server;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvU2VydmVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsc0RBQTREO0FBQzVELDZDQUF3QztBQUN4QywwQkFBa0Q7QUFDbEQsbUNBQW9DO0FBRXBDLDZDQUF3QztBQUloQyxpQkFKQSxlQUFNLENBSUE7QUFGZCwwQ0FBMkM7QUFJM0MsTUFBYSxNQUFPLFNBQVEscUJBQVk7SUE4RHBDLFdBQVc7SUFFWDtRQUNJLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxpQkFBTyxFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLGVBQU0sRUFBRSxDQUFDO0lBQy9CLENBQUM7SUF2Q0QsRUFBRSxDQUFDLEtBQWEsRUFBRSxRQUEyQjtRQUN6QyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztRQUMxQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBMEJELElBQUksQ0FBQyxLQUFhLEVBQUUsR0FBRyxJQUFJO1FBQ3ZCLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBVUQsSUFBSTtRQUNBLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDdEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFN0Isb0JBQW9CO1FBRXBCLHFCQUFxQjtRQUNyQixHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBQyxRQUFRLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2xELEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFFM0IsNkJBQTZCO1FBQzdCLEdBQUcsQ0FBQyxHQUFH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RSxNQUFNLEVBQUUsRUFBRTtZQUNuQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDdEIsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFO29CQUNQLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDZjtxQkFBTTtvQkFDSCxPQUFPLEVBQUUsQ0FBQztpQkFDYjtZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUEzTUQsd0JBMk1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MsIHtFeHByZXNzLCBSZXF1ZXN0LCBSZXNwb25zZX0gZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCB7Um91dGVzfSBmcm9tIFwiLi9MaWJyYXJ5L1JvdXRlc1wiO1xuaW1wb3J0IHtJbnZhbGlkUGFyYW1zLCBQYXJzZUVycm9yLCBSUEN9IGZyb20gXCIuLlwiO1xuaW1wb3J0IHtFdmVudEVtaXR0ZXJ9IGZyb20gXCJldmVudHNcIjtcbmltcG9ydCAqIGFzIGh0dHAgZnJvbSBcImh0dHBcIjtcbmltcG9ydCB7T3V0cHV0fSBmcm9tIFwiLi9MaWJyYXJ5L091dHB1dFwiO1xuaW1wb3J0IHtBZGRyZXNzSW5mb30gZnJvbSBcIm5ldFwiO1xuaW1wb3J0IGJvZHlQYXJzZXIgPSByZXF1aXJlKFwiYm9keS1wYXJzZXJcIik7XG5cbmV4cG9ydCB7T3V0cHV0fTtcblxuZXhwb3J0IGNsYXNzIFNlcnZlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgaGFuZGxlOiBFeHByZXNzO1xuICAgIGxpc3RlbmVyOiBodHRwLlNlcnZlcjtcbiAgICByb3V0ZXM6IFJvdXRlcztcblxuICAgIC8vcmVnaW9uIE9uXG5cbiAgICBvbihldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChwb3J0OiBudW1iZXIsIGhvc3RuYW1lOiBzdHJpbmcsIGJhY2tsb2c6IG51bWJlciwgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAocG9ydDogbnVtYmVyLCBob3N0bmFtZTogc3RyaW5nLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3Jlc3BvbnNlJywgY2FsbGJhY2s6IChvdXRwdXQ6IFJQQy5SZXNwb25zZS5JRGF0YSwgcmVxPzogUmVxdWVzdCwgcmVzPzogUmVzcG9uc2UpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZXF1ZXN0JywgY2FsbGJhY2s6IChib2R5OiBSUEMuUmVxdWVzdC5JRGF0YSwgcmVxPzogUmVxdWVzdCwgcmVzPzogUmVzcG9uc2UpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAocG9ydDogbnVtYmVyLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChwYXRoOiBzdHJpbmcsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKGhhbmRsZTogYW55LCBsaXN0ZW5pbmdMaXN0ZW5lcj86ICgpID0+IHZvaWQpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAoYWRkcmVzczogQWRkcmVzc0luZm8gfCBzdHJpbmcgfCBudWxsKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncm91dGluZycsIGNhbGxiYWNrOiAocmVxOiBSZXF1ZXN0KSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAnZXJyb3InLCBjYWxsYmFjazogKGU6IEVycm9yLCBib2R5PzogYW55LCByZXE/OiBSZXF1ZXN0LCByZXM/OiBSZXNwb25zZSkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogc3RyaW5nLCBsaXN0ZW5lcjogKC4uLmFyZ3MpID0+IHZvaWQpOiB0aGlzIHtcbiAgICAgICAgc3VwZXIub24oZXZlbnQsIGxpc3RlbmVyKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLy9lbmRyZWdpb25cblxuICAgIC8vcmVnaW9uIEVtaXRzXG5cbiAgICBlbWl0KGV2ZW50OiAncmVhZHknLCBwb3J0OiBudW1iZXIsIGhvc3RuYW1lOiBzdHJpbmcsIGJhY2tsb2c6IG51bWJlciwgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgcG9ydDogbnVtYmVyLCBob3N0bmFtZTogc3RyaW5nLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncmVzcG9uc2UnLCBvdXRwdXQ6IFJQQy5SZXNwb25zZS5JRGF0YSB8IFJQQy5SZXNwb25zZS5JRGF0YVtdLCByZXE/OiBSZXF1ZXN0LCByZXM/OiBSZXNwb25zZSk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAnZXJyb3InLCBlOiBFcnJvciwgYm9keT86IGFueSwgcmVxPzogUmVxdWVzdCwgcmVzPzogUmVzcG9uc2UpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgcG9ydDogbnVtYmVyLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncmVhZHknLCBwYXRoOiBzdHJpbmcsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyZWFkeScsIGhhbmRsZTogYW55LCBsaXN0ZW5pbmdMaXN0ZW5lcj86ICgpID0+IHZvaWQpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlcXVlc3QnLCBib2R5OiBhbnksIHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncmVhZHknLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncm91dGluZycsIHJlcTogUmVxdWVzdCk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiBzdHJpbmcsIC4uLmFyZ3MpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHN1cGVyLmVtaXQoZXZlbnQsIC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIC8vZW5kcmVnaW9uXG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5oYW5kbGUgPSBleHByZXNzKCk7XG4gICAgICAgIHRoaXMucm91dGVzID0gbmV3IFJvdXRlcygpO1xuICAgIH1cblxuICAgIGluaXQoKSB7XG4gICAgICAgIGxldCBhcHAgPSB0aGlzLmhhbmRsZTtcbiAgICAgICAgYXBwLnNldCgndHJ1c3QgcHJveHknLCB0cnVlKTtcblxuICAgICAgICAvL3JlZ2lvbiBNaWRkbGV3YXJlc1xuXG4gICAgICAgIC8vRm9yIHJlcXVlc3QgZW1pdHRlclxuICAgICAgICBhcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7ZXh0ZW5kZWQ6IGZhbHNlfSkpO1xuICAgICAgICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKTtcblxuICAgICAgICAvLyBFcnJvciBjYXRjaCBmb3IgYm9keVBhcnNlclxuICAgICAgICBhcHAudXNlKChlcnIsIHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgU3ludGF4RXJyb3IpIHtcbiAgICAgICAgICAgICAgICBuZXh0KG5ldyBQYXJzZUVycm9yKCkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuZXh0KGVyciwgcmVxLCByZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvL1BhcnNpbmcgYm9keVxuICAgICAgICBhcHAudXNlKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFyZXEuYm9keSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXh0KG5ldyBJbnZhbGlkUGFyYW1zKHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ1JlcXVlc3QgYm9keSBub3QgZm91bmQuJ1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGNoZWNrUGFyYW1zID0gKHJlcSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAnb2JqZWN0JyAhPT0gdHlwZW9mIHJlcS5ib2R5IHx8ICEoJ3N0cmluZycgPT09IHR5cGVvZiByZXEuYm9keS5tZXRob2QgJiYgcmVxLmJvZHkuaWQgJiYgcmVxLmJvZHkuaWQpO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY29uc3QgdGhyb3dJdCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dChuZXcgSW52YWxpZFBhcmFtcyh7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIEpTT04tUlBDIFJlcXVlc3QgQm9keSdcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAocmVxLmJvZHkgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiByZXEuYm9keSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWNoZWNrUGFyYW1zKGl0ZW0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dJdCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoIWNoZWNrUGFyYW1zKHJlcS5ib2R5KSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dJdCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbmV4dCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgLy9lbmRyZWdpb25cblxuICAgICAgICBhcHAudXNlKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdyZXF1ZXN0JywgcmVxLmJvZHksIHJlcSwgcmVzKTtcbiAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGFwcC51c2UoKGVyciwgcmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgICAgICAgIGxldCBvdXRwdXQgPSBPdXRwdXQuZ2VuZXJhdGUoZXJyLCByZXEuYm9keSB8fCB7fSk7XG4gICAgICAgICAgICByZXNcbiAgICAgICAgICAgICAgICAuc2VuZChvdXRwdXQpXG4gICAgICAgICAgICAgICAgLmVuZCgpO1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGVyciwgcmVxLmJvZHksIHJlcSwgcmVzKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYXBwLnBvc3QoJy8/JCcsIChyZXEsIHJlcykgPT4ge1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdyb3V0aW5nJywgcmVxKTtcbiAgICAgICAgICAgIHR5cGUgVEJvZHkgPSBSUEMuUmVxdWVzdC5JRGF0YTtcbiAgICAgICAgICAgIGxldCBib2R5OiBUQm9keSB8IFRCb2R5W10gPSByZXEuYm9keTtcbiAgICAgICAgICAgIGlmIChib2R5IGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoXG4gICAgICAgICAgICAgICAgICAgIGJvZHlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoYm9keUl0ZW0gPT4gdGhpc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yb3V0ZXNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2FsbChib2R5SXRlbS5tZXRob2QsIGJvZHlJdGVtLnBhcmFtcywgcmVxLCByZXMpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBPdXRwdXQuZ2VuZXJhdGUoZGF0YSwgYm9keUl0ZW0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gT3V0cHV0LmdlbmVyYXRlKGUsIGJvZHlJdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ3Jlc3BvbnNlJywgZGF0YSwgcmVxLCByZXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQoZGF0YSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZW5kKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRoaXNcbiAgICAgICAgICAgICAgICAucm91dGVzXG4gICAgICAgICAgICAgICAgLmNhbGwoYm9keS5tZXRob2QsIGJvZHkucGFyYW1zLCByZXEsIHJlcylcbiAgICAgICAgICAgICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy9PbiBzdWNjZXNzXG4gICAgICAgICAgICAgICAgICAgIGxldCBvdXRwdXQgPSBPdXRwdXQuZ2VuZXJhdGUoZGF0YSwgcmVxLmJvZHkpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ3Jlc3BvbnNlJywgb3V0cHV0LCByZXEsIHJlcyk7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5zZW5kKG91dHB1dClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5lbmQoKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaChlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy9PbiBlcnJvclxuICAgICAgICAgICAgICAgICAgICBsZXQgb3V0cHV0ID0gT3V0cHV0LmdlbmVyYXRlKGUsIHJlcS5ib2R5KTtcblxuICAgICAgICAgICAgICAgICAgICByZXMuc2VuZChvdXRwdXQpXG4gICAgICAgICAgICAgICAgICAgICAgICAuZW5kKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGUsIHJlcS5ib2R5LCByZXEsIHJlcyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBhcHAuZ2V0KCcvPyQnLCAoKSA9PiB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgUGFyc2VFcnJvcih1bmRlZmluZWQsICdKU09OUlBDIHNlcnZlciBoYW5kbGVzIG9ubHkgUE9TVCByZXF1ZXN0cycpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBsaXN0ZW4ocG9ydDogbnVtYmVyLCBob3N0Pzogc3RyaW5nKTogUHJvbWlzZTxodHRwLlNlcnZlcj4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHN1Y2MsIGVycikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubGlzdGVuZXIgPSB0aGlzLmhhbmRsZS5saXN0ZW4ocG9ydCwgaG9zdCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgncmVhZHknLCB0aGlzLmxpc3RlbmVyLmFkZHJlc3MoKSk7XG4gICAgICAgICAgICAgICAgc3VjYyh0aGlzLmxpc3RlbmVyKTtcbiAgICAgICAgICAgIH0pLm9uKCdlcnJvcicsIGVycik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNsb3NlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5saXN0ZW5lci5jbG9zZShlcnIgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghIWVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==