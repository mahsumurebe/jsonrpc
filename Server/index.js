"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const Routes_1 = require("./Library/Routes");
const __1 = require("..");
const events_1 = require("events");
const Output_1 = require("./Library/Output");
exports.Output = Output_1.Output;
const bodyParser = require("body-parser");
class Server extends events_1.EventEmitter {
    //endregion
    constructor() {
        super();
        this.handle = express_1.default();
        this.routes = new Routes_1.Routes();
    }
    on(event, listener) {
        super.on(event, listener);
        return this;
    }
    emit(event, ...args) {
        return super.emit(event, ...args);
    }
    init() {
        let app = this.handle;
        app.set('trust proxy', true);
        //region Middlewares
        //For request emitter
        app.use(bodyParser.urlencoded({ extended: false }));
        app.use(bodyParser.json());
        app.use((req, res, next) => {
            if (req.method !== 'POST') {
                const err = new __1.ParseError(undefined, 'JSONRPC server handles only POST requests');
                const output = Output_1.Output.generate(err, {
                    id: 1,
                    jsonrpc: '2.0',
                    method: undefined,
                    params: []
                });
                res.send(output)
                    .end();
            }
            else {
                next();
            }
        });
        // Error catch for bodyParser
        app.use((err, req, res, next) => {
            if (err instanceof SyntaxError) {
                next(new __1.ParseError());
            }
            else {
                next(err, req, res);
            }
        });
        //Parsing body
        app.use((req, res, next) => {
            if (!req.body) {
                return next(new __1.InvalidParams({
                    message: 'Request body not found.'
                }));
            }
            const checkParams = (req) => {
                return 'object' !== typeof req.body || !('string' === typeof req.body.method && req.body.id && req.body.id);
            };
            const throwIt = () => {
                return next(new __1.InvalidParams({
                    message: 'Invalid JSON-RPC Request Body'
                }));
            };
            if (req.body instanceof Array) {
                for (const item of req.body) {
                    if (!checkParams(item)) {
                        return throwIt();
                    }
                }
            }
            else {
                if (!checkParams(req.body)) {
                    return throwIt();
                }
            }
            next();
        });
        //endregion
        app.use((req, res, next) => {
            this.emit('request', req.body, req, res);
            next();
        });
        app.use((err, req, res, next) => {
            let output = Output_1.Output.generate(err, req.body || {});
            res
                .send(output)
                .end();
            this.emit('error', err, req.body, req, res);
        });
        app.post('/?$', (req, res) => {
            this.emit('routing', req);
            let body = req.body;
            if (body instanceof Array) {
                return Promise.all(body
                    .map(bodyItem => this
                    .routes
                    .call(bodyItem.method, bodyItem.params, req, res)
                    .then(data => {
                    return Output_1.Output.generate(data, bodyItem);
                })
                    .catch(e => {
                    return Output_1.Output.generate(e, bodyItem);
                })))
                    .then(data => {
                    this.emit('response', data, req, res);
                    res.send(data)
                        .end();
                });
            }
            return this
                .routes
                .call(body.method, body.params, req, res)
                .then(data => {
                //On success
                let output = Output_1.Output.generate(data, req.body);
                this.emit('response', output, req, res);
                res.send(output)
                    .end();
            })
                .catch(e => {
                //On error
                let output = Output_1.Output.generate(e, req.body);
                res.send(output)
                    .end();
                this.emit('error', e, req.body, req, res);
            });
        });
    }
    listen(port, host) {
        return new Promise((succ, err) => {
            return this.listener = this.handle.listen(port, host, () => {
                this.emit('ready', this.listener.address());
                succ(this.listener);
            }).on('error', err);
        });
    }
    close() {
        return new Promise((resolve, reject) => {
            this.listener.close(err => {
                if (!!err) {
                    reject(err);
                }
                else {
                    resolve();
                }
            });
        });
    }
}
exports.Server = Server;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvU2VydmVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsc0RBQTREO0FBQzVELDZDQUF3QztBQUN4QywwQkFBa0Q7QUFDbEQsbUNBQW9DO0FBRXBDLDZDQUF3QztBQUloQyxpQkFKQSxlQUFNLENBSUE7QUFGZCwwQ0FBMkM7QUFJM0MsTUFBYSxNQUFPLFNBQVEscUJBQVk7SUE4RHBDLFdBQVc7SUFFWDtRQUNJLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxpQkFBTyxFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLGVBQU0sRUFBRSxDQUFDO0lBQy9CLENBQUM7SUF2Q0QsRUFBRSxDQUFDLEtBQWEsRUFBRSxRQUEyQjtRQUN6QyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztRQUMxQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBMEJELElBQUksQ0FBQyxLQUFhLEVBQUUsR0FBRyxJQUFJO1FBQ3ZCLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBVUQsSUFBSTtRQUNBLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDdEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFN0Isb0JBQW9CO1FBRXBCLHFCQUFxQjtRQUNyQixHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBQyxRQUFRLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2xELEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFFM0IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdB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R0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRTtnQkFDdkQsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO2dCQUM1QyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3hCLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsS0FBSztRQUNELE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDbkMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQ3RCLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRTtvQkFDUCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ2Y7cUJBQU07b0JBQ0gsT0FBTyxFQUFFLENBQUM7aUJBQ2I7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKO0FBeE5ELHdCQXdOQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzLCB7RXhwcmVzcywgUmVxdWVzdCwgUmVzcG9uc2V9IGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQge1JvdXRlc30gZnJvbSBcIi4vTGlicmFyeS9Sb3V0ZXNcIjtcbmltcG9ydCB7SW52YWxpZFBhcmFtcywgUGFyc2VFcnJvciwgUlBDfSBmcm9tIFwiLi5cIjtcbmltcG9ydCB7RXZlbnRFbWl0dGVyfSBmcm9tIFwiZXZlbnRzXCI7XG5pbXBvcnQgKiBhcyBodHRwIGZyb20gXCJodHRwXCI7XG5pbXBvcnQge091dHB1dH0gZnJvbSBcIi4vTGlicmFyeS9PdXRwdXRcIjtcbmltcG9ydCB7QWRkcmVzc0luZm99IGZyb20gXCJuZXRcIjtcbmltcG9ydCBib2R5UGFyc2VyID0gcmVxdWlyZShcImJvZHktcGFyc2VyXCIpO1xuXG5leHBvcnQge091dHB1dH07XG5cbmV4cG9ydCBjbGFzcyBTZXJ2ZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGhhbmRsZTogRXhwcmVzcztcbiAgICBsaXN0ZW5lcjogaHR0cC5TZXJ2ZXI7XG4gICAgcm91dGVzOiBSb3V0ZXM7XG5cbiAgICAvL3JlZ2lvbiBPblxuXG4gICAgb24oZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAocG9ydDogbnVtYmVyLCBob3N0bmFtZTogc3RyaW5nLCBiYWNrbG9nOiBudW1iZXIsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBvcnQ6IG51bWJlciwgaG9zdG5hbWU6IHN0cmluZywgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZXNwb25zZScsIGNhbGxiYWNrOiAob3V0cHV0OiBSUEMuUmVzcG9uc2UuSURhdGEsIHJlcT86IFJlcXVlc3QsIHJlcz86IFJlc3BvbnNlKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVxdWVzdCcsIGNhbGxiYWNrOiAoYm9keTogUlBDLlJlcXVlc3QuSURhdGEsIHJlcT86IFJlcXVlc3QsIHJlcz86IFJlc3BvbnNlKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKHBvcnQ6IG51bWJlciwgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6ICdyZWFkeScsIGNhbGxiYWNrOiAocGF0aDogc3RyaW5nLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChoYW5kbGU6IGFueSwgbGlzdGVuaW5nTGlzdGVuZXI/OiAoKSA9PiB2b2lkKSA9PiB2b2lkKTogdGhpcztcblxuICAgIG9uKGV2ZW50OiAncmVhZHknLCBjYWxsYmFjazogKGFkZHJlc3M6IEFkZHJlc3NJbmZvIHwgc3RyaW5nIHwgbnVsbCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JlYWR5JywgY2FsbGJhY2s6IChjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ3JvdXRpbmcnLCBjYWxsYmFjazogKHJlcTogUmVxdWVzdCkgPT4gdm9pZCk6IHRoaXM7XG5cbiAgICBvbihldmVudDogJ2Vycm9yJywgY2FsbGJhY2s6IChlOiBFcnJvciwgYm9keT86IGFueSwgcmVxPzogUmVxdWVzdCwgcmVzPzogUmVzcG9uc2UpID0+IHZvaWQpOiB0aGlzO1xuXG4gICAgb24oZXZlbnQ6IHN0cmluZywgbGlzdGVuZXI6ICguLi5hcmdzKSA9PiB2b2lkKTogdGhpcyB7XG4gICAgICAgIHN1cGVyLm9uKGV2ZW50LCBsaXN0ZW5lcik7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8vZW5kcmVnaW9uXG5cbiAgICAvL3JlZ2lvbiBFbWl0c1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgcG9ydDogbnVtYmVyLCBob3N0bmFtZTogc3RyaW5nLCBiYWNrbG9nOiBudW1iZXIsIGNhbGxiYWNrPzogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyZWFkeScsIHBvcnQ6IG51bWJlciwgaG9zdG5hbWU6IHN0cmluZywgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3Jlc3BvbnNlJywgb3V0cHV0OiBSUEMuUmVzcG9uc2UuSURhdGEgfCBSUEMuUmVzcG9uc2UuSURhdGFbXSwgcmVxPzogUmVxdWVzdCwgcmVzPzogUmVzcG9uc2UpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ2Vycm9yJywgZTogRXJyb3IsIGJvZHk/OiBhbnksIHJlcT86IFJlcXVlc3QsIHJlcz86IFJlc3BvbnNlKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyZWFkeScsIHBvcnQ6IG51bWJlciwgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgcGF0aDogc3RyaW5nLCBjYWxsYmFjaz86ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCk6IGJvb2xlYW47XG5cbiAgICBlbWl0KGV2ZW50OiAncmVhZHknLCBoYW5kbGU6IGFueSwgbGlzdGVuaW5nTGlzdGVuZXI/OiAoKSA9PiB2b2lkKTogYm9vbGVhbjtcblxuICAgIGVtaXQoZXZlbnQ6ICdyZXF1ZXN0JywgYm9keTogYW55LCByZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JlYWR5JywgY2FsbGJhY2s/OiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogJ3JvdXRpbmcnLCByZXE6IFJlcXVlc3QpOiBib29sZWFuO1xuXG4gICAgZW1pdChldmVudDogc3RyaW5nLCAuLi5hcmdzKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBzdXBlci5lbWl0KGV2ZW50LCAuLi5hcmdzKTtcbiAgICB9XG5cbiAgICAvL2VuZHJlZ2lvblxuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuaGFuZGxlID0gZXhwcmVzcygpO1xuICAgICAgICB0aGlzLnJvdXRlcyA9IG5ldyBSb3V0ZXMoKTtcbiAgICB9XG5cbiAgICBpbml0KCkge1xuICAgICAgICBsZXQgYXBwID0gdGhpcy5oYW5kbGU7XG4gICAgICAgIGFwcC5zZXQoJ3RydXN0IHByb3h5JywgdHJ1ZSk7XG5cbiAgICAgICAgLy9yZWdpb24gTWlkZGxld2FyZXNcblxuICAgICAgICAvL0ZvciByZXF1ZXN0IGVtaXR0ZXJcbiAgICAgICAgYXBwLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoe2V4dGVuZGVkOiBmYWxzZX0pKTtcbiAgICAgICAgYXBwLnVzZShib2R5UGFyc2VyLmpzb24oKSk7XG5cbiAgICAgICAgYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgICAgICAgIGlmIChyZXEubWV0aG9kICE9PSAnUE9TVCcpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlcnIgPSBuZXcgUGFyc2VFcnJvcih1bmRlZmluZWQsICdKU09OUlBDIHNlcnZlciBoYW5kbGVzIG9ubHkgUE9TVCByZXF1ZXN0cycpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IE91dHB1dC5nZW5lcmF0ZShlcnIsIHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6IDEsXG4gICAgICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zOiBbXVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHJlcy5zZW5kKG91dHB1dClcbiAgICAgICAgICAgICAgICAgICAgLmVuZCgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEVycm9yIGNhdGNoIGZvciBib2R5UGFyc2VyXG4gICAgICAgIGFwcC51c2UoKGVyciwgcmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikge1xuICAgICAgICAgICAgICAgIG5leHQobmV3IFBhcnNlRXJyb3IoKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5leHQoZXJyLCByZXEsIHJlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vUGFyc2luZyBib2R5XG4gICAgICAgIGFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgICAgICBpZiAoIXJlcS5ib2R5KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5leHQobmV3IEludmFsaWRQYXJhbXMoe1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnUmVxdWVzdCBib2R5IG5vdCBmb3VuZC4nXG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgY2hlY2tQYXJhbXMgPSAocmVxKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICdvYmplY3QnICE9PSB0eXBlb2YgcmVxLmJvZHkgfHwgISgnc3RyaW5nJyA9PT0gdHlwZW9mIHJlcS5ib2R5Lm1ldGhvZCAmJiByZXEuYm9keS5pZCAmJiByZXEuYm9keS5pZCk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCB0aHJvd0l0ID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXh0KG5ldyBJbnZhbGlkUGFyYW1zKHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ0ludmFsaWQgSlNPTi1SUEMgUmVxdWVzdCBCb2R5J1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChyZXEuYm9keSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHJlcS5ib2R5KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghY2hlY2tQYXJhbXMoaXRlbSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aHJvd0l0KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICghY2hlY2tQYXJhbXMocmVxLmJvZHkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aHJvd0l0KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgIH0pO1xuICAgICAgICAvL2VuZHJlZ2lvblxuXG4gICAgICAgIGFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3JlcXVlc3QnLCByZXEuYm9keSwgcmVxLCByZXMpO1xuICAgICAgICAgICAgbmV4dCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgYXBwLnVzZSgoZXJyLCByZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICAgICAgbGV0IG91dHB1dCA9IE91dHB1dC5nZW5lcmF0ZShlcnIsIHJlcS5ib2R5IHx8IHt9KTtcbiAgICAgICAgICAgIHJlc1xuICAgICAgICAgICAgICAgIC5zZW5kKG91dHB1dClcbiAgICAgICAgICAgICAgICAuZW5kKCk7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyLCByZXEuYm9keSwgcmVxLCByZXMpO1xuICAgICAgICB9KTtcblxuICAgICAgICBhcHAucG9zdCgnLz8kJywgKHJlcSwgcmVzKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3JvdXRpbmcnLCByZXEpO1xuICAgICAgICAgICAgdHlwZSBUQm9keSA9IFJQQy5SZXF1ZXN0LklEYXRhO1xuICAgICAgICAgICAgbGV0IGJvZHk6IFRCb2R5IHwgVEJvZHlbXSA9IHJlcS5ib2R5O1xuICAgICAgICAgICAgaWYgKGJvZHkgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChcbiAgICAgICAgICAgICAgICAgICAgYm9keVxuICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChib2R5SXRlbSA9PiB0aGlzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJvdXRlc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jYWxsKGJvZHlJdGVtLm1ldGhvZCwgYm9keUl0ZW0ucGFyYW1zLCByZXEsIHJlcylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE91dHB1dC5nZW5lcmF0ZShkYXRhLCBib2R5SXRlbSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBPdXRwdXQuZ2VuZXJhdGUoZSwgYm9keUl0ZW0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgncmVzcG9uc2UnLCBkYXRhLCByZXEsIHJlcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXMuc2VuZChkYXRhKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5lbmQoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpc1xuICAgICAgICAgICAgICAgIC5yb3V0ZXNcbiAgICAgICAgICAgICAgICAuY2FsbChib2R5Lm1ldGhvZCwgYm9keS5wYXJhbXMsIHJlcSwgcmVzKVxuICAgICAgICAgICAgICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvL09uIHN1Y2Nlc3NcbiAgICAgICAgICAgICAgICAgICAgbGV0IG91dHB1dCA9IE91dHB1dC5nZW5lcmF0ZShkYXRhLCByZXEuYm9keSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgncmVzcG9uc2UnLCBvdXRwdXQsIHJlcSwgcmVzKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQob3V0cHV0KVxuICAgICAgICAgICAgICAgICAgICAgICAgLmVuZCgpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvL09uIGVycm9yXG4gICAgICAgICAgICAgICAgICAgIGxldCBvdXRwdXQgPSBPdXRwdXQuZ2VuZXJhdGUoZSwgcmVxLmJvZHkpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJlcy5zZW5kKG91dHB1dClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5lbmQoKTtcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZSwgcmVxLmJvZHksIHJlcSwgcmVzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgbGlzdGVuKHBvcnQ6IG51bWJlciwgaG9zdD86IHN0cmluZyk6IFByb21pc2U8aHR0cC5TZXJ2ZXI+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChzdWNjLCBlcnIpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmxpc3RlbmVyID0gdGhpcy5oYW5kbGUubGlzdGVuKHBvcnQsIGhvc3QsICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ3JlYWR5JywgdGhpcy5saXN0ZW5lci5hZGRyZXNzKCkpO1xuICAgICAgICAgICAgICAgIHN1Y2ModGhpcy5saXN0ZW5lcik7XG4gICAgICAgICAgICB9KS5vbignZXJyb3InLCBlcnIpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjbG9zZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMubGlzdGVuZXIuY2xvc2UoZXJyID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoISFlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=